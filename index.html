<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Kunjungan Pasien</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
        body {
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(to bottom right, #1F2937, #111827);
            color: #F9FAFB;
        }
        body.dark-mode .bg-white {
            background-color: #1F2937 !important;
        }
        body.dark-mode .text-gray-800 {
            color: #F9FAFB !important;
        }
        body.dark-mode .text-gray-700 {
            color: #D1D5DB !important;
        }
        body.dark-mode .text-gray-600 {
            color: #9CA3AF !important;
        }
        body.dark-mode .text-gray-900 {
            color: #F3F4F6 !important;
        }
        body.dark-mode .text-gray-500 {
            color: #9CA3AF !important;
        }
        body.dark-mode .bg-gray-50 {
            background-color: #374151 !important;
        }
        body.dark-mode .bg-gray-100 {
            background-color: #4B5563 !important;
        }
        body.dark-mode .border-gray-200 {
            border-color: #4B5563 !important;
        }
        body.dark-mode .border-gray-300 {
            border-color: #6B7280 !important;
        }
        body.dark-mode .divide-gray-200 > * {
            border-color: #4B5563 !important;
        }
        body.dark-mode .hover\:bg-gray-50:hover {
            background-color: #374151 !important;
        }
        body.dark-mode .filter-dropdown-content {
            background-color: #1F2937;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
        }
        body.dark-mode .filter-option:hover {
            background-color: #374151;
        }
        body.dark-mode input[type="text"],
        body.dark-mode button:not(.tab-button):not(.tab-button.active) {
            background-color: #374151;
            color: #F9FAFB;
            border-color: #6B7280;
        }
        
        .tab-button {
            background: #E5E7EB;
            color: #4B5563;
        }
        .tab-button.active {
            background: #3B82F6;
            color: white;
        }
        .tab-button:hover:not(.active) {
            background: #D1D5DB;
        }
        body.dark-mode .tab-button {
            background: #4B5563;
            color: #D1D5DB;
        }
        body.dark-mode .tab-button:hover:not(.active) {
            background: #6B7280;
        }
        
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .filter-dropdown {
            position: relative;
        }
        .filter-dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 250px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 8px;
            margin-top: 4px;
        }
        .filter-dropdown-content.show {
            display: block;
        }
        .filter-option {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .filter-option:hover {
            background-color: #F3F4F6;
        }
        
        /* Animated Counter */
        .counter {
            display: inline-block;
        }
        
        /* Chart Comparison Mode */
        .comparison-mode {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            overflow: auto;
            padding: 20px;
        }
        .comparison-mode.active {
            display: flex;
            flex-direction: column;
        }
        .comparison-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: auto;
            max-width: 1400px;
            width: 100%;
        }
        body.dark-mode .comparison-content {
            background: #1F2937;
        }
        
        /* Enhanced Tooltips */
        .chart-container {
            position: relative;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full w-full bg-gradient-to-br from-blue-50 to-green-50">
  <div class="w-full h-full overflow-auto">
   <div class="container-wrapper mx-auto px-2 sm:px-4 py-4 sm:py-8 max-w-full"><!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-green-600 rounded-xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
     <div class="flex justify-between items-start mb-2">
      <div>
       <h1 id="dashboard-title" class="text-2xl sm:text-3xl font-bold text-white mb-2">Dashboard Kunjungan Pasien</h1>
       <p id="dashboard-subtitle" class="text-sm sm:text-base text-white opacity-90">Analisis Data Kunjungan</p>
      </div>
      <div class="flex gap-2"><!-- Dark Mode Toggle --> <button onclick="toggleDarkMode()" class="px-3 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-lg transition-all" title="Toggle Dark Mode"> <span id="dark-mode-icon">ğŸŒ™</span> </button> <!-- Export Full PDF --> <button onclick="exportFullDashboard()" class="px-3 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-lg transition-all text-sm font-medium hidden sm:block" title="Export Full Dashboard"> ğŸ“„ Export All </button> <!-- Comparison Mode --> <button onclick="openComparisonMode()" class="px-3 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-lg transition-all text-sm font-medium hidden sm:block" title="Compare Charts"> ğŸ“Š Compare </button>
      </div>
     </div><!-- Tab Navigation -->
     <div class="flex gap-2 mt-4 flex-wrap"><button onclick="switchTab('overview')" id="tab-overview" class="tab-button px-3 sm:px-4 py-2 rounded-lg font-medium transition-all text-sm sm:text-base"> ğŸ“Š Overview </button> <button onclick="switchTab('pelayanan')" id="tab-pelayanan" class="tab-button px-3 sm:px-4 py-2 rounded-lg font-medium transition-all text-sm sm:text-base"> ğŸ¥ Pelayanan </button> <button onclick="switchTab('status')" id="tab-status" class="tab-button px-3 sm:px-4 py-2 rounded-lg font-medium transition-all text-sm sm:text-base"> ğŸ“‹ Status </button> <button onclick="switchTab('analisa')" id="tab-analisa" class="tab-button px-3 sm:px-4 py-2 rounded-lg font-medium transition-all text-sm sm:text-base"> ï¿½ï¿½ Analisa </button>
     </div>
    </div><!-- Loading State -->
    <div id="loading-state" class="bg-white rounded-xl shadow-lg p-12 text-center">
     <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
     <p class="text-gray-600">Memuat data dari Google Sheets...</p>
    </div><!-- Error State -->
    <div id="error-state" class="bg-red-50 border border-red-200 rounded-xl p-6 mb-6 hidden">
     <div class="flex items-start">
      <svg class="w-6 h-6 text-red-600 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <div>
       <h3 class="text-red-800 font-semibold mb-1">Gagal Memuat Data</h3>
       <p id="error-message" class="text-red-700 text-sm"></p>
      </div>
     </div>
    </div><!-- Main Content -->
    <div id="main-content" class="hidden"><!-- Global Filters -->
     <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
      <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">Filter Data (Berlaku Untuk Semua Tab)</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4"><!-- Filter Tahun -->
       <div class="filter-dropdown"><label class="block text-sm font-medium text-gray-700 mb-2">Tahun</label> <button onclick="toggleDropdown('tahun')" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-left bg-white flex justify-between items-center"> <span id="label-tahun" class="text-sm sm:text-base">Semua Tahun</span>
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
         </svg></button>
        <div id="dropdown-tahun" class="filter-dropdown-content">
         <div class="filter-option" onclick="selectAllFilter('tahun')"><input type="checkbox" id="check-all-tahun" checked> <label class="cursor-pointer font-medium">Pilih Semua</label>
         </div>
         <div class="border-t border-gray-200"></div>
         <div id="options-tahun"></div>
        </div>
       </div><!-- Filter Bulan -->
       <div class="filter-dropdown"><label class="block text-sm font-medium text-gray-700 mb-2">Bulan</label> <button onclick="toggleDropdown('bulan')" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-left bg-white flex justify-between items-center"> <span id="label-bulan" class="text-sm sm:text-base">Semua Bulan</span>
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
         </svg></button>
        <div id="dropdown-bulan" class="filter-dropdown-content">
         <div class="filter-option" onclick="selectAllFilter('bulan')"><input type="checkbox" id="check-all-bulan" checked> <label class="cursor-pointer font-medium">Pilih Semua</label>
         </div>
         <div class="border-t border-gray-200"></div>
         <div id="options-bulan"></div>
        </div>
       </div><!-- Filter Klinik -->
       <div class="filter-dropdown"><label class="block text-sm font-medium text-gray-700 mb-2">Klinik</label> <button onclick="toggleDropdown('klinik')" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-left bg-white flex justify-between items-center"> <span id="label-klinik" class="text-sm sm:text-base">Semua Klinik</span>
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
         </svg></button>
        <div id="dropdown-klinik" class="filter-dropdown-content">
         <div class="filter-option" onclick="selectAllFilter('klinik')"><input type="checkbox" id="check-all-klinik" checked> <label class="cursor-pointer font-medium">Pilih Semua</label>
         </div>
         <div class="border-t border-gray-200"></div>
         <div id="options-klinik"></div>
        </div>
       </div><!-- Filter Jenis Pelayanan -->
       <div class="filter-dropdown"><label class="block text-sm font-medium text-gray-700 mb-2">Jenis Pelayanan</label> <button onclick="toggleDropdown('pelayanan')" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-left bg-white flex justify-between items-center"> <span id="label-pelayanan" class="text-sm sm:text-base">Semua Pelayanan</span>
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
         </svg></button>
        <div id="dropdown-pelayanan" class="filter-dropdown-content">
         <div class="filter-option" onclick="selectAllFilter('pelayanan')"><input type="checkbox" id="check-all-pelayanan" checked> <label class="cursor-pointer font-medium">Pilih Semua</label>
         </div>
         <div class="border-t border-gray-200"></div>
         <div id="options-pelayanan"></div>
        </div>
       </div><!-- Filter Jenis Kelamin -->
       <div class="filter-dropdown"><label class="block text-sm font-medium text-gray-700 mb-2">Jenis Kelamin</label> <button onclick="toggleDropdown('kelamin')" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-left bg-white flex justify-between items-center"> <span id="label-kelamin" class="text-sm sm:text-base">Semua Gender</span>
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
         </svg></button>
        <div id="dropdown-kelamin" class="filter-dropdown-content">
         <div class="filter-option" onclick="selectAllFilter('kelamin')"><input type="checkbox" id="check-all-kelamin" checked> <label class="cursor-pointer font-medium">Pilih Semua</label>
         </div>
         <div class="border-t border-gray-200"></div>
         <div id="options-kelamin"></div>
        </div>
       </div><!-- Toggle Values & Reset -->
       <div class="flex flex-col gap-2 justify-end"><label class="flex items-center space-x-2 cursor-pointer"> <input type="checkbox" id="toggle-values" class="w-5 h-5 text-blue-600 rounded"> <span class="text-sm font-medium text-gray-700">Tampilkan Angka</span> </label> <button onclick="resetAllFilters()" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition-colors"> ğŸ”„ Reset Filter </button>
       </div>
      </div>
     </div><!-- Tab Content: Overview -->
     <div id="content-overview" class="tab-content active"><!-- KPI Cards -->
      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 sm:gap-4 mb-4 sm:mb-6">
       <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-4 sm:p-5 text-white">
        <div class="flex items-center justify-between mb-2">
         <h3 class="text-xs font-medium opacity-90">Total</h3>
         <svg class="w-6 h-6 sm:w-7 sm:h-7 opacity-80" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
         </svg>
        </div>
        <p id="kpi-total" class="text-xl sm:text-2xl font-bold counter">0</p>
       </div>
       <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-4 sm:p-5 text-white">
        <div class="flex items-center justify-between mb-2">
         <h3 class="text-xs font-medium opacity-90">Poliklinik</h3>
         <svg class="w-6 h-6 sm:w-7 sm:h-7 opacity-80" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
         </svg>
        </div>
        <p id="kpi-poliklinik" class="text-xl sm:text-2xl font-bold counter">0</p>
       </div>
       <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-4 sm:p-5 text-white">
        <div class="flex items-center justify-between mb-2">
         <h3 class="text-xs font-medium opacity-90">MCU</h3>
         <svg class="w-6 h-6 sm:w-7 sm:h-7 opacity-80" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
         </svg>
        </div>
        <p id="kpi-mcu" class="text-xl sm:text-2xl font-bold counter">0</p>
       </div>
       <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-lg p-4 sm:p-5 text-white">
        <div class="flex items-center justify-between mb-2">
         <h3 class="text-xs font-medium opacity-90">IGD</h3>
         <svg class="w-6 h-6 sm:w-7 sm:h-7 opacity-80" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
         </svg>
        </div>
        <p id="kpi-igd" class="text-xl sm:text-2xl font-bold counter">0</p>
       </div>
       <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-4 sm:p-5 text-white">
        <div class="flex items-center justify-between mb-2">
         <h3 class="text-xs font-medium opacity-90">Rawat Inap</h3>
         <svg class="w-6 h-6 sm:w-7 sm:h-7 opacity-80" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
         </svg>
        </div>
        <p id="kpi-rawat-inap" class="text-xl sm:text-2xl font-bold counter">0</p>
       </div>
      </div><!-- Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mb-4 sm:mb-6">
       <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 chart-container">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
         <h3 class="text-base sm:text-lg font-bold text-gray-800">Tren Kunjungan</h3>
         <div class="flex gap-2 flex-wrap"><button onclick="toggleChartType('chart-tren')" id="btn-toggle-chart-tren" class="px-3 py-1 bg-purple-600 text-white text-xs sm:text-sm rounded-lg hover:bg-purple-700 font-medium transition-colors"> ğŸ“Š Bar Chart </button> <button onclick="downloadChart('chart-tren', 'tren_kunjungan')" class="px-3 py-1 bg-blue-600 text-white text-xs sm:text-sm rounded-lg hover:bg-blue-700 transition-colors"> ğŸ“Š PNG </button> <button onclick="exportChartPDF('chart-tren', 'Tren Kunjungan')" class="px-3 py-1 bg-red-600 text-white text-xs sm:text-sm rounded-lg hover:bg-red-700 transition-colors"> ğŸ“„ PDF </button>
         </div>
        </div>
        <canvas id="chart-tren"></canvas>
       </div>
       <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 chart-container">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
         <h3 class="text-base sm:text-lg font-bold text-gray-800">Top 10 Klinik</h3>
         <div class="flex gap-2 flex-wrap"><button onclick="toggleChartType('chart-klinik')" id="btn-toggle-chart-klinik" class="px-3 py-1 bg-purple-600 text-white text-xs sm:text-sm rounded-lg hover:bg-purple-700 font-medium transition-colors"> ğŸ“Š Bar Chart </button> <button onclick="downloadChart('chart-klinik', 'top_10_klinik')" class="px-3 py-1 bg-blue-600 text-white text-xs sm:text-sm rounded-lg hover:bg-blue-700 transition-colors"> ğŸ“Š PNG </button> <button onclick="exportChartPDF('chart-klinik', 'Top 10 Klinik')" class="px-3 py-1 bg-red-600 text-white text-xs sm:text-sm rounded-lg hover:bg-red-700 transition-colors"> ğŸ“„ PDF </button>
         </div>
        </div>
        <canvas id="chart-klinik"></canvas>
       </div>
      </div><!-- Distribusi Kunjungan Per Jenis Pelayanan -->
      <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
       <h3 class="text-base sm:text-lg font-bold text-gray-800 mb-4">Distribusi Kunjungan Pasien Berdasarkan Jenis Pelayanan</h3>
       <div class="grid grid-cols-1 lg:grid-cols-2 gap-4"><!-- Poliklinik -->
        <div class="border-2 border-blue-200 rounded-xl p-4 bg-gradient-to-br from-blue-50 to-white">
         <div class="flex justify-between items-start mb-3">
          <div>
           <h4 class="text-base font-bold text-blue-700 mb-2">Kunjungan Pasien â€“ Poliklinik</h4>
           <div class="flex flex-wrap gap-2 mb-2"><span id="badge-poliklinik-total" class="px-3 py-1 bg-blue-600 text-white text-xs font-bold rounded-full">Total: 0</span>
           </div>
           <div class="flex flex-wrap gap-2"><span id="badge-poliklinik-l" class="px-3 py-1 bg-blue-500 text-white text-xs font-semibold rounded-full">L: 0 (0%)</span> <span id="badge-poliklinik-p" class="px-3 py-1 bg-pink-500 text-white text-xs font-semibold rounded-full">P: 0 (0%)</span>
           </div>
          </div>
          <div class="flex flex-col gap-2"><button onclick="toggleChartType('chart-poliklinik')" id="btn-toggle-chart-poliklinik" class="px-2 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700 font-medium"> ğŸ“Š Bar </button> <button onclick="downloadChart('chart-poliklinik', 'poliklinik_gender')" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700"> ğŸ“Š PNG </button>
          </div>
         </div>
         <canvas id="chart-poliklinik"></canvas>
        </div><!-- MCU -->
        <div class="border-2 border-purple-200 rounded-xl p-4 bg-gradient-to-br from-purple-50 to-white">
         <div class="flex justify-between items-start mb-3">
          <div>
           <h4 class="text-base font-bold text-purple-700 mb-2">Kunjungan Pasien â€“ MCU</h4>
           <div class="flex flex-wrap gap-2 mb-2"><span id="badge-mcu-total" class="px-3 py-1 bg-purple-600 text-white text-xs font-bold rounded-full">Total: 0</span>
           </div>
           <div class="flex flex-wrap gap-2"><span id="badge-mcu-l" class="px-3 py-1 bg-blue-500 text-white text-xs font-semibold rounded-full">L: 0 (0%)</span> <span id="badge-mcu-p" class="px-3 py-1 bg-pink-500 text-white text-xs font-semibold rounded-full">P: 0 (0%)</span>
           </div>
          </div>
          <div class="flex flex-col gap-2"><button onclick="toggleChartType('chart-mcu')" id="btn-toggle-chart-mcu" class="px-2 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700 font-medium"> ğŸ“Š Bar </button> <button onclick="downloadChart('chart-mcu', 'mcu_gender')" class="px-2 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700"> ğŸ“Š PNG </button>
          </div>
         </div>
         <canvas id="chart-mcu"></canvas>
        </div><!-- IGD -->
        <div class="border-2 border-red-200 rounded-xl p-4 bg-gradient-to-br from-red-50 to-white">
         <div class="flex justify-between items-start mb-3">
          <div>
           <h4 class="text-base font-bold text-red-700 mb-2">Kunjungan Pasien â€“ IGD</h4>
           <div class="flex flex-wrap gap-2 mb-2"><span id="badge-igd-total" class="px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-full">Total: 0</span>
           </div>
           <div class="flex flex-wrap gap-2"><span id="badge-igd-l" class="px-3 py-1 bg-blue-500 text-white text-xs font-semibold rounded-full">L: 0 (0%)</span> <span id="badge-igd-p" class="px-3 py-1 bg-pink-500 text-white text-xs font-semibold rounded-full">P: 0 (0%)</span>
           </div>
          </div>
          <div class="flex flex-col gap-2"><button onclick="toggleChartType('chart-igd')" id="btn-toggle-chart-igd" class="px-2 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700 font-medium"> ï¿½ï¿½ Bar </button> <button onclick="downloadChart('chart-igd', 'igd_gender')" class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700"> ğŸ“Š PNG </button>
          </div>
         </div>
         <canvas id="chart-igd"></canvas>
        </div><!-- Rawat Inap -->
        <div class="border-2 border-orange-200 rounded-xl p-4 bg-gradient-to-br from-orange-50 to-white">
         <div class="flex justify-between items-start mb-3">
          <div>
           <h4 class="text-base font-bold text-orange-700 mb-2">Kunjungan Pasien â€“ Rawat Inap</h4>
           <div class="flex flex-wrap gap-2 mb-2"><span id="badge-ri-total" class="px-3 py-1 bg-orange-600 text-white text-xs font-bold rounded-full">Total: 0</span>
           </div>
           <div class="flex flex-wrap gap-2"><span id="badge-ri-l" class="px-3 py-1 bg-blue-500 text-white text-xs font-semibold rounded-full">L: 0 (0%)</span> <span id="badge-ri-p" class="px-3 py-1 bg-pink-500 text-white text-xs font-semibold rounded-full">P: 0 (0%)</span>
           </div>
          </div>
          <div class="flex flex-col gap-2"><button onclick="toggleChartType('chart-ri')" id="btn-toggle-chart-ri" class="px-2 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700 font-medium"> ğŸ“Š Bar </button> <button onclick="downloadChart('chart-ri', 'rawat_inap_gender')" class="px-2 py-1 bg-orange-600 text-white text-xs rounded hover:bg-orange-700"> ğŸ“Š PNG </button>
          </div>
         </div>
         <canvas id="chart-ri"></canvas>
        </div>
       </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mb-4 sm:mb-6">
       <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 chart-container">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
         <h3 class="text-base sm:text-lg font-bold text-gray-800">Jenis Kelamin</h3>
         <div class="flex gap-2 flex-wrap"><button onclick="downloadChart('chart-gender', 'jenis_kelamin')" class="px-3 py-1 bg-blue-600 text-white text-xs sm:text-sm rounded-lg hover:bg-blue-700 transition-colors"> ğŸ“Š PNG </button> <button onclick="exportChartPDF('chart-gender', 'Distribusi Jenis Kelamin')" class="px-3 py-1 bg-red-600 text-white text-xs sm:text-sm rounded-lg hover:bg-red-700 transition-colors"> ğŸ“„ PDF </button>
         </div>
        </div>
        <canvas id="chart-gender"></canvas>
       </div>
       <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 chart-container">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
         <h3 class="text-base sm:text-lg font-bold text-gray-800">Cara Bayar</h3>
         <div class="flex gap-2 flex-wrap"><button onclick="downloadChart('chart-bayar', 'cara_bayar')" class="px-3 py-1 bg-blue-600 text-white text-xs sm:text-sm rounded-lg hover:bg-blue-700 transition-colors"> ğŸ“Š PNG </button> <button onclick="exportChartPDF('chart-bayar', 'Cara Bayar / Jaminan')" class="px-3 py-1 bg-red-600 text-white text-xs sm:text-sm rounded-lg hover:bg-red-700 transition-colors"> ğŸ“„ PDF </button>
         </div>
        </div>
        <canvas id="chart-bayar"></canvas>
       </div>
      </div><!-- Table -->
      <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
       <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
        <h3 class="text-base sm:text-lg font-bold text-gray-800">Rekap Overview</h3>
        <div class="flex gap-2 flex-wrap"><button onclick="exportTableToCSV('overview')" class="px-3 sm:px-4 py-2 bg-green-600 text-white text-xs sm:text-sm rounded-lg hover:bg-green-700 transition-colors"> ğŸ“¥ CSV </button> <button onclick="exportTableToPDF('overview')" class="px-3 sm:px-4 py-2 bg-red-600 text-white text-xs sm:text-sm rounded-lg hover:bg-red-700 transition-colors"> ğŸ“„ PDF </button>
        </div>
       </div>
       <div class="overflow-x-auto">
        <table class="w-full text-sm">
         <thead class="bg-gray-50">
          <tr>
           <th class="px-3 sm:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kategori</th>
           <th class="px-3 sm:px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
           <th class="px-3 sm:px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">%</th>
          </tr>
         </thead>
         <tbody id="table-overview-body" class="bg-white divide-y divide-gray-200">
         </tbody>
         <tfoot class="bg-gray-100">
          <tr class="font-bold">
           <td class="px-3 sm:px-4 py-3 text-sm text-gray-900">TOTAL</td>
           <td id="total-overview" class="px-3 sm:px-4 py-3 text-sm text-gray-900 text-right">0</td>
           <td class="px-3 sm:px-4 py-3 text-sm text-gray-900 text-right">100%</td>
          </tr>
         </tfoot>
        </table>
       </div>
      </div><!-- Detail Table -->
      <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6">
       <div class="flex flex-col gap-4 mb-4">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
         <h3 class="text-base sm:text-lg font-bold text-gray-800">Data Detail</h3>
         <div class="flex gap-2 flex-wrap"><button onclick="exportDetailToCSV()" class="px-3 py-2 bg-green-600 text-white text-xs sm:text-sm rounded-lg hover:bg-green-700 transition-colors"> ğŸ“¥ CSV </button> <button onclick="exportDetailToPDF()" class="px-3 py-2 bg-red-600 text-white text-xs sm:text-sm rounded-lg hover:bg-red-700 transition-colors"> ğŸ“„ PDF </button>
         </div>
        </div>
        <div class="flex flex-col sm:flex-row gap-2 items-start sm:items-center"><input type="text" id="search-table" placeholder="Cari..." class="px-4 py-2 border border-gray-300 rounded-lg w-full sm:w-64 text-sm">
         <div class="flex items-center gap-2"><label class="text-sm text-gray-700 font-medium">Per halaman:</label> <select id="items-per-page" onchange="changeItemsPerPage()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm"> <option value="10">10</option> <option value="15" selected>15</option> <option value="50">50</option> <option value="100">100</option> <option value="200">200</option> <option value="500">500</option> </select>
         </div>
        </div>
        <div class="border-t pt-3">
         <p class="text-sm font-medium text-gray-700 mb-2">Tampilkan Kolom:</p>
         <div class="flex flex-wrap gap-3"><label class="flex items-center space-x-2 cursor-pointer"> <input type="checkbox" id="col-periode" checked onchange="toggleColumn('periode')" class="w-4 h-4 text-blue-600 rounded"> <span class="text-sm text-gray-700">Periode</span> </label> <label class="flex items-center space-x-2 cursor-pointer"> <input type="checkbox" id="col-jenis" checked onchange="toggleColumn('jenis')" class="w-4 h-4 text-blue-600 rounded"> <span class="text-sm text-gray-700">Jenis Pelayanan</span> </label> <label class="flex items-center space-x-2 cursor-pointer"> <input type="checkbox" id="col-klinik" checked onchange="toggleColumn('klinik')" class="w-4 h-4 text-blue-600 rounded"> <span class="text-sm text-gray-700">Klinik</span> </label> <label class="flex items-center space-x-2 cursor-pointer"> <input type="checkbox" id="col-status" checked onchange="toggleColumn('status')" class="w-4 h-4 text-blue-600 rounded"> <span class="text-sm text-gray-700">Status</span> </label> <label class="flex items-center space-x-2 cursor-pointer"> <input type="checkbox" id="col-bayar" checked onchange="toggleColumn('bayar')" class="w-4 h-4 text-blue-600 rounded"> <span class="text-sm text-gray-700">Cara Bayar</span> </label> <label class="flex items-center space-x-2 cursor-pointer"> <input type="checkbox" id="col-laki" checked onchange="toggleColumn('laki')" class="w-4 h-4 text-blue-600 rounded"> <span class="text-sm text-gray-700">Laki-laki</span> </label> <label class="flex items-center space-x-2 cursor-pointer"> <input type="checkbox" id="col-perempuan" checked onchange="toggleColumn('perempuan')" class="w-4 h-4 text-blue-600 rounded"> <span class="text-sm text-gray-700">Perempuan</span> </label> <label class="flex items-center space-x-2 cursor-pointer"> <input type="checkbox" id="col-total" checked onchange="toggleColumn('total')" class="w-4 h-4 text-blue-600 rounded"> <span class="text-sm text-gray-700">Total</span> </label>
         </div>
        </div>
       </div>
       <div class="overflow-x-auto" style="max-height: 600px; overflow-y: auto;">
        <table class="w-full text-sm">
         <thead class="bg-gray-50 sticky top-0 z-10">
          <tr id="detail-table-header">
           <th class="px-3 sm:px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">No</th>
           <th class="px-3 sm:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-periode cursor-pointer hover:bg-gray-100" onclick="toggleSort('periode')">
            <div class="flex items-center gap-1">
             Periode <span id="sort-icon-periode">â‡…</span>
            </div></th>
           <th class="px-3 sm:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-jenis cursor-pointer hover:bg-gray-100" onclick="toggleSort('jenis')">
            <div class="flex items-center gap-1">
             Jenis Pelayanan <span id="sort-icon-jenis">â‡…</span>
            </div></th>
           <th class="px-3 sm:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-klinik cursor-pointer hover:bg-gray-100" onclick="toggleSort('klinik')">
            <div class="flex items-center gap-1">
             Klinik <span id="sort-icon-klinik">â‡…</span>
            </div></th>
           <th class="px-3 sm:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-status cursor-pointer hover:bg-gray-100" onclick="toggleSort('status')">
            <div class="flex items-center gap-1">
             Status <span id="sort-icon-status">â‡…</span>
            </div></th>
           <th class="px-3 sm:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase col-bayar cursor-pointer hover:bg-gray-100" onclick="toggleSort('bayar')">
            <div class="flex items-center gap-1">
             Cara Bayar <span id="sort-icon-bayar">â‡…</span>
            </div></th>
           <th class="px-3 sm:px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase col-laki cursor-pointer hover:bg-gray-100" onclick="toggleSort('laki')">
            <div class="flex items-center justify-end gap-1">
             Laki-laki <span id="sort-icon-laki">â‡…</span>
            </div></th>
           <th class="px-3 sm:px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase col-perempuan cursor-pointer hover:bg-gray-100" onclick="toggleSort('perempuan')">
            <div class="flex items-center justify-end gap-1">
             Perempuan <span id="sort-icon-perempuan">â‡…</span>
            </div></th>
           <th class="px-3 sm:px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase col-total cursor-pointer hover:bg-gray-100" onclick="toggleSort('total')">
            <div class="flex items-center justify-end gap-1">
             Total <span id="sort-icon-total">â‡…</span>
            </div></th>
          </tr>
         </thead>
         <tbody id="table-body" class="bg-white divide-y divide-gray-200">
         </tbody>
         <tfoot class="bg-gray-100 sticky bottom-0">
          <tr class="font-bold" id="detail-table-footer">
           <td class="px-3 sm:px-4 py-3 text-sm text-gray-900" colspan="6">TOTAL KESELURUHAN</td>
           <td class="px-3 sm:px-4 py-3 text-sm text-gray-900 text-right col-laki" id="footer-laki">0</td>
           <td class="px-3 sm:px-4 py-3 text-sm text-gray-900 text-right col-perempuan" id="footer-perempuan">0</td>
           <td class="px-3 sm:px-4 py-3 text-sm text-gray-900 text-right col-total" id="footer-total">0</td>
          </tr>
         </tfoot>
        </table>
       </div>
       <div class="flex flex-col sm:flex-row justify-between items-center mt-4 gap-2">
        <p id="table-info" class="text-sm text-gray-600">0 data</p>
        <div class="flex gap-2"><button id="btn-prev" class="px-3 sm:px-4 py-2 border rounded-lg text-xs sm:text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"> Prev </button> <button id="btn-next" class="px-3 sm:px-4 py-2 border rounded-lg text-xs sm:text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"> Next </button>
        </div>
       </div>
      </div>
     </div><!-- Tab Pelayanan -->
     <div id="content-pelayanan" class="tab-content">
      <div class="grid grid-cols-1 gap-4 sm:gap-6 mb-4 sm:mb-6">
       <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 chart-container">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
         <h3 class="text-base sm:text-lg font-bold text-gray-800">Per Jenis Pelayanan</h3>
         <div class="flex gap-2 flex-wrap"><button onclick="toggleChartType('chart-pelayanan-jenis')" id="btn-toggle-chart-pelayanan-jenis" class="px-3 py-1 bg-purple-600 text-white text-xs sm:text-sm rounded-lg hover:bg-purple-700 font-medium transition-colors"> ğŸ“Š Bar Chart </button> <button onclick="downloadChart('chart-pelayanan-jenis', 'pelayanan_jenis')" class="px-3 py-1 bg-blue-600 text-white text-xs sm:text-sm rounded-lg hover:bg-blue-700"> ğŸ“Š PNG </button> <button onclick="exportChartPDF('chart-pelayanan-jenis', 'Pelayanan Per Jenis')" class="px-3 py-1 bg-red-600 text-white text-xs sm:text-sm rounded-lg hover:bg-red-700"> ğŸ“„ PDF </button>
         </div>
        </div>
        <canvas id="chart-pelayanan-jenis"></canvas>
       </div>
       <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 chart-container">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
         <h3 class="text-base sm:text-lg font-bold text-gray-800">Per Klinik (Top 15)</h3>
         <div class="flex gap-2 flex-wrap"><button onclick="toggleChartType('chart-pelayanan-klinik')" id="btn-toggle-chart-pelayanan-klinik" class="px-3 py-1 bg-purple-600 text-white text-xs sm:text-sm rounded-lg hover:bg-purple-700 font-medium transition-colors"> ğŸ“Š Bar Chart </button> <button onclick="downloadChart('chart-pelayanan-klinik', 'pelayanan_klinik')" class="px-3 py-1 bg-blue-600 text-white text-xs sm:text-sm rounded-lg hover:bg-blue-700"> ğŸ“Š PNG </button> <button onclick="exportChartPDF('chart-pelayanan-klinik', 'Pelayanan Per Klinik')" class="px-3 py-1 bg-red-600 text-white text-xs sm:text-sm rounded-lg hover:bg-red-700"> ğŸ“„ PDF </button>
         </div>
        </div>
        <canvas id="chart-pelayanan-klinik"></canvas>
       </div>
      </div><!-- Tables -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
       <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
         <h3 class="text-base sm:text-lg font-bold text-gray-800">Tabel Per Jenis</h3>
         <div class="flex gap-2 flex-wrap"><button onclick="exportTableToCSV('pelayanan-jenis')" class="px-3 py-1 bg-green-600 text-white text-xs sm:text-sm rounded-lg hover:bg-green-700"> ğŸ“¥ CSV </button> <button onclick="exportTableToPDF('pelayanan-jenis')" class="px-3 py-1 bg-red-600 text-white text-xs sm:text-sm rounded-lg hover:bg-red-700"> ğŸ“„ PDF </button>
         </div>
        </div>
        <div class="overflow-x-auto">
         <table class="w-full text-sm">
          <thead class="bg-gray-50">
           <tr>
            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Jenis</th>
            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">%</th>
           </tr>
          </thead>
          <tbody id="table-pelayanan-jenis-body" class="bg-white divide-y divide-gray-200">
          </tbody>
          <tfoot class="bg-gray-100">
           <tr class="font-bold">
            <td class="px-3 py-2 text-xs">TOTAL</td>
            <td id="total-pelayanan-jenis" class="px-3 py-2 text-xs text-right">0</td>
            <td class="px-3 py-2 text-xs text-right">100%</td>
           </tr>
          </tfoot>
         </table>
        </div>
       </div>
       <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
         <h3 class="text-base sm:text-lg font-bold text-gray-800">Tabel Per Klinik</h3>
         <div class="flex gap-2 flex-wrap"><button onclick="exportTableToCSV('pelayanan-klinik')" class="px-3 py-1 bg-green-600 text-white text-xs sm:text-sm rounded-lg hover:bg-green-700"> ğŸ“¥ CSV </button> <button onclick="exportTableToPDF('pelayanan-klinik')" class="px-3 py-1 bg-red-600 text-white text-xs sm:text-sm rounded-lg hover:bg-red-700"> ğŸ“„ PDF </button>
         </div>
        </div>
        <div class="overflow-x-auto">
         <table class="w-full text-sm">
          <thead class="bg-gray-50">
           <tr>
            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Klinik</th>
            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">%</th>
           </tr>
          </thead>
          <tbody id="table-pelayanan-klinik-body" class="bg-white divide-y divide-gray-200">
          </tbody>
          <tfoot class="bg-gray-100">
           <tr class="font-bold">
            <td class="px-3 py-2 text-xs">TOTAL</td>
            <td id="total-pelayanan-klinik" class="px-3 py-2 text-xs text-right">0</td>
            <td class="px-3 py-2 text-xs text-right">100%</td>
           </tr>
          </tfoot>
         </table>
        </div>
       </div>
      </div>
     </div><!-- Tab Status -->
     <div id="content-status" class="tab-content">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mb-4 sm:mb-6">
       <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 chart-container">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
         <h3 class="text-base sm:text-lg font-bold text-gray-800">Status Cara Bayar</h3>
         <div class="flex gap-2 flex-wrap"><button onclick="downloadChart('chart-status-bayar', 'status_bayar')" class="px-3 py-1 bg-blue-600 text-white text-xs sm:text-sm rounded-lg hover:bg-blue-700"> ğŸ“Š PNG </button> <button onclick="exportChartPDF('chart-status-bayar', 'Status Cara Bayar')" class="px-3 py-1 bg-red-600 text-white text-xs sm:text-sm rounded-lg hover:bg-red-700"> ğŸ“„ PDF </button>
         </div>
        </div>
        <canvas id="chart-status-bayar"></canvas>
       </div>
       <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 chart-container">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
         <h3 class="text-base sm:text-lg font-bold text-gray-800">Status Jaminan</h3>
         <div class="flex gap-2 flex-wrap"><button onclick="downloadChart('chart-status-jaminan', 'status_jaminan')" class="px-3 py-1 bg-blue-600 text-white text-xs sm:text-sm rounded-lg hover:bg-blue-700"> ğŸ“Š PNG </button> <button onclick="exportChartPDF('chart-status-jaminan', 'Status Jaminan')" class="px-3 py-1 bg-red-600 text-white text-xs sm:text-sm rounded-lg hover:bg-red-700"> ğŸ“„ PDF </button>
         </div>
        </div>
        <canvas id="chart-status-jaminan"></canvas>
       </div>
      </div><!-- Tables -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
       <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
         <h3 class="text-base sm:text-lg font-bold text-gray-800">Tabel Cara Bayar</h3>
         <div class="flex gap-2 flex-wrap"><button onclick="exportTableToCSV('status-bayar')" class="px-3 py-1 bg-green-600 text-white text-xs sm:text-sm rounded-lg hover:bg-green-700"> ğŸ“¥ CSV </button> <button onclick="exportTableToPDF('status-bayar')" class="px-3 py-1 bg-red-600 text-white text-xs sm:text-sm rounded-lg hover:bg-red-700"> ğŸ“„ PDF </button>
         </div>
        </div>
        <div class="overflow-x-auto">
         <table class="w-full text-sm">
          <thead class="bg-gray-50">
           <tr>
            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cara Bayar</th>
            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">%</th>
           </tr>
          </thead>
          <tbody id="table-status-bayar-body" class="bg-white divide-y divide-gray-200">
          </tbody>
          <tfoot class="bg-gray-100">
           <tr class="font-bold">
            <td class="px-3 py-2 text-xs">TOTAL</td>
            <td id="total-status-bayar" class="px-3 py-2 text-xs text-right">0</td>
            <td class="px-3 py-2 text-xs text-right">100%</td>
           </tr>
          </tfoot>
         </table>
        </div>
       </div>
       <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
         <h3 class="text-base sm:text-lg font-bold text-gray-800">Tabel Jaminan</h3>
         <div class="flex gap-2 flex-wrap"><button onclick="exportTableToCSV('status-jaminan')" class="px-3 py-1 bg-green-600 text-white text-xs sm:text-sm rounded-lg hover:bg-green-700"> ğŸ“¥ CSV </button> <button onclick="exportTableToPDF('status-jaminan')" class="px-3 py-1 bg-red-600 text-white text-xs sm:text-sm rounded-lg hover:bg-red-700"> ğŸ“„ PDF </button>
         </div>
        </div>
        <div class="overflow-x-auto">
         <table class="w-full text-sm">
          <thead class="bg-gray-50">
           <tr>
            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Jaminan</th>
            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">%</th>
           </tr>
          </thead>
          <tbody id="table-status-jaminan-body" class="bg-white divide-y divide-gray-200">
          </tbody>
          <tfoot class="bg-gray-100">
           <tr class="font-bold">
            <td class="px-3 py-2 text-xs">TOTAL</td>
            <td id="total-status-jaminan" class="px-3 py-2 text-xs text-right">0</td>
            <td class="px-3 py-2 text-xs text-right">100%</td>
           </tr>
          </tfoot>
         </table>
        </div>
       </div>
      </div>
     </div><!-- Tab Analisa -->
     <div id="content-analisa" class="tab-content">
      <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6 chart-container">
       <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
        <h3 class="text-base sm:text-lg font-bold text-gray-800">Perbandingan Multi-Tahun</h3>
        <div class="flex gap-2 flex-wrap"><button onclick="downloadChart('chart-analisa', 'analisa_multi_tahun')" class="px-3 py-1 bg-blue-600 text-white text-xs sm:text-sm rounded-lg hover:bg-blue-700"> ğŸ“Š PNG </button> <button onclick="exportChartPDF('chart-analisa', 'Analisa Per Periode')" class="px-3 py-1 bg-red-600 text-white text-xs sm:text-sm rounded-lg hover:bg-red-700"> ğŸ“„ PDF </button>
        </div>
       </div>
       <canvas id="chart-analisa"></canvas>
      </div>
      <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6">
       <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
        <h3 class="text-base sm:text-lg font-bold text-gray-800">Tabel Analisa</h3>
        <div class="flex gap-2 flex-wrap"><button onclick="exportTableToCSV('analisa')" class="px-3 py-1 bg-green-600 text-white text-xs sm:text-sm rounded-lg hover:bg-green-700"> ğŸ“¥ CSV </button> <button onclick="exportTableToPDF('analisa')" class="px-3 py-1 bg-red-600 text-white text-xs sm:text-sm rounded-lg hover:bg-red-700"> ğŸ“„ PDF </button>
        </div>
       </div>
       <div class="overflow-x-auto">
        <table class="w-full text-sm">
         <thead class="bg-gray-50" id="table-analisa-head">
         </thead>
         <tbody id="table-analisa-body" class="bg-white divide-y divide-gray-200">
         </tbody>
         <tfoot class="bg-gray-100" id="table-analisa-foot">
         </tfoot>
        </table>
       </div>
      </div>
     </div>
    </div><!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-8 py-4">
     <p class="text-center text-sm text-gray-600">Dibuat oleh Tim Pelaporan RSUD Drs. H. Amri Tambunan Â© 2025</p>
    </footer>
   </div>
  </div><!-- Chart Comparison Modal -->
  <div id="comparison-modal" class="comparison-mode">
   <div class="comparison-content">
    <div class="flex justify-between items-center mb-4">
     <h2 class="text-xl font-bold text-gray-800">Perbandingan Grafik</h2><button onclick="closeComparisonMode()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"> âœ• Tutup </button>
    </div>
    <div class="grid grid-cols-1 gap-4 mb-4">
     <div><label class="block text-sm font-medium text-gray-700 mb-2">Pilih Grafik 1:</label> <select id="compare-chart-1" class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">-- Pilih Grafik --</option> <option value="chart-tren">Tren Kunjungan</option> <option value="chart-klinik">Top 10 Klinik</option> <option value="chart-pelayanan-jenis">Pelayanan Per Jenis</option> <option value="chart-pelayanan-klinik">Pelayanan Per Klinik</option> <option value="chart-analisa">Analisa Multi-Tahun</option> </select>
     </div>
     <div><label class="block text-sm font-medium text-gray-700 mb-2">Pilih Grafik 2:</label> <select id="compare-chart-2" class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">-- Pilih Grafik --</option> <option value="chart-tren">Tren Kunjungan</option> <option value="chart-klinik">Top 10 Klinik</option> <option value="chart-pelayanan-jenis">Pelayanan Per Jenis</option> <option value="chart-pelayanan-klinik">Pelayanan Per Klinik</option> <option value="chart-analisa">Analisa Multi-Tahun</option> </select>
     </div><button onclick="renderComparison()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium"> ğŸ”„ Bandingkan </button>
    </div>
    <div id="comparison-result" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
     <div class="border border-gray-200 rounded-lg p-4">
      <h3 class="font-bold mb-2 text-gray-800" id="title-compare-1">Grafik 1</h3>
      <canvas id="canvas-compare-1"></canvas>
     </div>
     <div class="border border-gray-200 rounded-lg p-4">
      <h3 class="font-bold mb-2 text-gray-800" id="title-compare-2">Grafik 2</h3>
      <canvas id="canvas-compare-2"></canvas>
     </div>
    </div>
   </div>
  </div>
  <script>
        Chart.register(ChartDataLabels);

        // Global variables
        let rawData = [];
        let filteredData = [];
        let charts = {};
        let chartTypes = {};
        let comparisonCharts = {};
        let ITEMS_PER_PAGE = 15;
        let currentPage = 1;
        let searchQuery = '';
        let currentTab = 'overview';
        let visibleColumns = {
            periode: true,
            klinik: true,
            jenis: true,
            laki: true,
            perempuan: true,
            bayar: true,
            status: true,
            total: true
        };
        let sortColumn = null;
        let sortDirection = 'none'; // 'none', 'asc', 'desc'

        // Filter states
        let selectedTahun = new Set();
        let selectedBulan = new Set();
        let selectedKlinik = new Set();
        let selectedPelayanan = new Set();
        let selectedKelamin = new Set();

        const monthOrder = {
            'Januari': 1, 'Februari': 2, 'Maret': 3, 'April': 4, 'Mei': 5, 'Juni': 6,
            'Juli': 7, 'Agustus': 8, 'September': 9, 'Oktober': 10, 'November': 11, 'Desember': 12
        };

        const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                            'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

        // Dark Mode Toggle
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const icon = document.getElementById('dark-mode-icon');
            if (document.body.classList.contains('dark-mode')) {
                icon.textContent = 'â˜€ï¸';
                localStorage.setItem('darkMode', 'enabled');
            } else {
                icon.textContent = 'ğŸŒ™';
                localStorage.setItem('darkMode', 'disabled');
            }
        }

        // Load dark mode preference
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark-mode');
            document.getElementById('dark-mode-icon').textContent = 'â˜€ï¿½ï¿½ï¿½';
        }

        // Animated Counter
        function animateCounter(element, target) {
            const duration = 1000;
            const start = 0;
            const increment = target / (duration / 16);
            let current = start;
            
            const timer = setInterval(function() {
                current += increment;
                if (current >= target) {
                    current = target;
                    clearInterval(timer);
                }
                element.textContent = Math.floor(current).toLocaleString('id-ID');
            }, 16);
        }

        // Export Full Dashboard
        async function exportFullDashboard() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            
            // Title
            pdf.setFontSize(18);
            pdf.setTextColor(59, 130, 246);
            pdf.text('Dashboard Kunjungan Pasien - Full Report', pageWidth / 2, 15, { align: 'center' });
            pdf.setFontSize(10);
            pdf.setTextColor(100);
            pdf.text('Generated: ' + new Date().toLocaleString('id-ID'), pageWidth / 2, 22, { align: 'center' });
            
            let yPos = 30;
            
            // Get all charts
            const chartIds = ['chart-tren', 'chart-klinik', 'chart-gender', 'chart-bayar'];
            
            for (let i = 0; i < chartIds.length; i++) {
                if (yPos > pageHeight - 80) {
                    pdf.addPage();
                    yPos = 20;
                }
                
                const canvas = document.getElementById(chartIds[i]);
                if (canvas) {
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = pageWidth - 20;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    pdf.addImage(imgData, 'PNG', 10, yPos, imgWidth, Math.min(imgHeight, 60));
                    yPos += Math.min(imgHeight, 60) + 10;
                }
            }
            
            pdf.save('dashboard_full_report_' + new Date().getTime() + '.pdf');
        }

        // Chart Comparison
        function openComparisonMode() {
            document.getElementById('comparison-modal').classList.add('active');
        }

        function closeComparisonMode() {
            document.getElementById('comparison-modal').classList.remove('active');
        }

        function renderComparison() {
            const chart1Id = document.getElementById('compare-chart-1').value;
            const chart2Id = document.getElementById('compare-chart-2').value;
            
            if (!chart1Id || !chart2Id) {
                alert('Pilih kedua grafik untuk dibandingkan');
                return;
            }
            
            // Clear previous comparison
            if (comparisonCharts.compare1) comparisonCharts.compare1.destroy();
            if (comparisonCharts.compare2) comparisonCharts.compare2.destroy();
            
            // Clone chart data
            const originalChart1 = charts[chart1Id];
            const originalChart2 = charts[chart2Id];
            
            if (!originalChart1 || !originalChart2) {
                alert('Grafik tidak ditemukan. Pastikan grafik sudah dimuat.');
                return;
            }
            
            // Set titles
            document.getElementById('title-compare-1').textContent = getChartTitle(chart1Id);
            document.getElementById('title-compare-2').textContent = getChartTitle(chart2Id);
            
            // Render charts
            const ctx1 = document.getElementById('canvas-compare-1').getContext('2d');
            const ctx2 = document.getElementById('canvas-compare-2').getContext('2d');
            
            comparisonCharts.compare1 = new Chart(ctx1, {
                type: originalChart1.config.type,
                data: JSON.parse(JSON.stringify(originalChart1.config.data)),
                options: JSON.parse(JSON.stringify(originalChart1.config.options))
            });
            
            comparisonCharts.compare2 = new Chart(ctx2, {
                type: originalChart2.config.type,
                data: JSON.parse(JSON.stringify(originalChart2.config.data)),
                options: JSON.parse(JSON.stringify(originalChart2.config.options))
            });
        }

        function getChartTitle(chartId) {
            const titles = {
                'chart-tren': 'Tren Kunjungan',
                'chart-klinik': 'Top 10 Klinik',
                'chart-pelayanan-jenis': 'Pelayanan Per Jenis',
                'chart-pelayanan-klinik': 'Pelayanan Per Klinik',
                'chart-analisa': 'Analisa Multi-Tahun'
            };
            return titles[chartId] || 'Grafik';
        }

        // Enhanced Chart Options with Interactive Tooltips
        function getEnhancedChartOptions(showValues, chartType = 'line') {
            return {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        display: showValues,
                        anchor: 'end',
                        align: 'top',
                        font: { weight: 'bold', size: 10 },
                        formatter: function(v) { return v > 0 ? v.toLocaleString('id-ID') : ''; }
                    },
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#3B82F6',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return context[0].label || '';
                            },
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += context.parsed.y.toLocaleString('id-ID');
                                
                                // Calculate percentage if applicable
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed.y / total) * 100).toFixed(1);
                                label += ' (' + percentage + '%)';
                                
                                return label;
                            }
                        }
                    }
                },
                scales: { y: { beginAtZero: true } },
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            };
        }

        // Toggle Chart Type
        function toggleChartType(chartId) {
            const currentType = chartTypes[chartId] || 'line';
            const newType = currentType === 'line' ? 'bar' : 'line';
            chartTypes[chartId] = newType;
            
            // Update button text
            const button = document.getElementById('btn-toggle-' + chartId);
            if (button) {
                if (newType === 'bar') {
                    button.innerHTML = 'ğŸ“ˆ Line Chart';
                } else {
                    button.innerHTML = 'ğŸ“Š Bar Chart';
                }
            }
            
            updateCurrentTab();
        }

        // Dropdown toggle
        function toggleDropdown(type) {
            const dropdown = document.getElementById('dropdown-' + type);
            const isShow = dropdown.classList.contains('show');
            
            document.querySelectorAll('.filter-dropdown-content').forEach(function(d) {
                d.classList.remove('show');
            });
            
            if (!isShow) {
                dropdown.classList.add('show');
            }
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.filter-dropdown')) {
                document.querySelectorAll('.filter-dropdown-content').forEach(function(d) {
                    d.classList.remove('show');
                });
            }
        });

        function selectAllFilter(type) {
            const checkAll = document.getElementById('check-all-' + type);
            const isChecked = checkAll.checked;
            
            const checkboxes = document.querySelectorAll('#options-' + type + ' input[type="checkbox"]');
            checkboxes.forEach(function(cb) {
                cb.checked = isChecked;
            });
            
            if (type === 'tahun') {
                if (isChecked) {
                    selectedTahun = new Set([...rawData.map(function(d) { return d.tahun; })].filter(function(t) { return t; }));
                } else {
                    selectedTahun.clear();
                }
            } else if (type === 'bulan') {
                if (isChecked) {
                    selectedBulan = new Set(monthNames);
                } else {
                    selectedBulan.clear();
                }
            } else if (type === 'klinik') {
                if (isChecked) {
                    selectedKlinik = new Set([...rawData.map(function(d) { return d.pelayanan; })].filter(function(p) { return p; }));
                } else {
                    selectedKlinik.clear();
                }
            } else if (type === 'pelayanan') {
                if (isChecked) {
                    selectedPelayanan = new Set([...rawData.map(function(d) { return d.jenisPelayanan; })].filter(function(p) { return p; }));
                } else {
                    selectedPelayanan.clear();
                }
            } else if (type === 'kelamin') {
                if (isChecked) {
                    selectedKelamin = new Set([...rawData.map(function(d) { return d.kelamin; })].filter(function(k) { return k; }));
                } else {
                    selectedKelamin.clear();
                }
            }
            
            updateFilterLabel(type);
            applyFilters();
        }

        function toggleFilterOption(type, value, event) {
            if (event) {
                event.stopPropagation();
            }
            
            if (type === 'tahun') {
                if (selectedTahun.has(value)) {
                    selectedTahun.delete(value);
                } else {
                    selectedTahun.add(value);
                }
            } else if (type === 'bulan') {
                if (selectedBulan.has(value)) {
                    selectedBulan.delete(value);
                } else {
                    selectedBulan.add(value);
                }
            } else if (type === 'klinik') {
                if (selectedKlinik.has(value)) {
                    selectedKlinik.delete(value);
                } else {
                    selectedKlinik.add(value);
                }
            } else if (type === 'pelayanan') {
                if (selectedPelayanan.has(value)) {
                    selectedPelayanan.delete(value);
                } else {
                    selectedPelayanan.add(value);
                }
            } else if (type === 'kelamin') {
                if (selectedKelamin.has(value)) {
                    selectedKelamin.delete(value);
                } else {
                    selectedKelamin.add(value);
                }
            }
            
            updateFilterLabel(type);
            applyFilters();
        }

        function updateFilterLabel(type) {
            let selectedSet, label, allItems;
            
            if (type === 'tahun') {
                selectedSet = selectedTahun;
                allItems = [...new Set(rawData.map(function(d) { return d.tahun; }))].filter(function(t) { return t; }).length;
                label = document.getElementById('label-tahun');
            } else if (type === 'bulan') {
                selectedSet = selectedBulan;
                allItems = monthNames.length;
                label = document.getElementById('label-bulan');
            } else if (type === 'klinik') {
                selectedSet = selectedKlinik;
                allItems = [...new Set(rawData.map(function(d) { return d.pelayanan; }))].filter(function(p) { return p; }).length;
                label = document.getElementById('label-klinik');
            } else if (type === 'pelayanan') {
                selectedSet = selectedPelayanan;
                allItems = [...new Set(rawData.map(function(d) { return d.jenisPelayanan; }))].filter(function(p) { return p; }).length;
                label = document.getElementById('label-pelayanan');
            } else if (type === 'kelamin') {
                selectedSet = selectedKelamin;
                allItems = [...new Set(rawData.map(function(d) { return d.kelamin; }))].filter(function(k) { return k; }).length;
                label = document.getElementById('label-kelamin');
            }
            
            const checkAllId = 'check-all-' + type;
            const checkAll = document.getElementById(checkAllId);
            
            if (selectedSet.size === 0) {
                label.textContent = 'Tidak Ada';
                if (checkAll) checkAll.checked = false;
            } else if (selectedSet.size === allItems) {
                if (type === 'tahun') label.textContent = 'Semua Tahun';
                else if (type === 'bulan') label.textContent = 'Semua Bulan';
                else if (type === 'klinik') label.textContent = 'Semua Klinik';
                else if (type === 'pelayanan') label.textContent = 'Semua Pelayanan';
                else if (type === 'kelamin') label.textContent = 'Semua Gender';
                if (checkAll) checkAll.checked = true;
            } else {
                label.textContent = selectedSet.size + ' dipilih';
                if (checkAll) checkAll.checked = false;
            }
        }

        function resetAllFilters() {
            selectedTahun = new Set([...rawData.map(function(d) { return d.tahun; })].filter(function(t) { return t; }));
            selectedBulan = new Set(monthNames);
            selectedKlinik = new Set([...rawData.map(function(d) { return d.pelayanan; })].filter(function(p) { return p; }));
            selectedPelayanan = new Set([...rawData.map(function(d) { return d.jenisPelayanan; })].filter(function(p) { return p; }));
            selectedKelamin = new Set([...rawData.map(function(d) { return d.kelamin; })].filter(function(k) { return k; }));
            
            const allCheckboxes = document.querySelectorAll('.filter-dropdown input[type="checkbox"]');
            allCheckboxes.forEach(function(cb) {
                cb.checked = true;
            });
            
            updateFilterLabel('tahun');
            updateFilterLabel('bulan');
            updateFilterLabel('klinik');
            updateFilterLabel('pelayanan');
            updateFilterLabel('kelamin');
            
            document.getElementById('toggle-values').checked = false;
            
            // Reset sorting
            sortColumn = null;
            sortDirection = 'none';
            updateSortIcons();
            
            applyFilters();
        }

        function toggleSort(columnName) {
            if (sortColumn === columnName) {
                // Cycle through: none -> asc -> desc -> none
                if (sortDirection === 'none') {
                    sortDirection = 'asc';
                } else if (sortDirection === 'asc') {
                    sortDirection = 'desc';
                } else {
                    sortDirection = 'none';
                    sortColumn = null;
                }
            } else {
                sortColumn = columnName;
                sortDirection = 'asc';
            }
            
            updateSortIcons();
            currentPage = 1;
            updateTable();
        }

        function updateSortIcons() {
            // Reset all icons
            const columns = ['periode', 'jenis', 'klinik', 'status', 'bayar', 'laki', 'perempuan', 'total'];
            columns.forEach(function(col) {
                const icon = document.getElementById('sort-icon-' + col);
                if (icon) {
                    if (sortColumn === col) {
                        if (sortDirection === 'asc') {
                            icon.textContent = 'â†‘';
                            icon.style.color = '#3B82F6';
                        } else if (sortDirection === 'desc') {
                            icon.textContent = 'â†“';
                            icon.style.color = '#3B82F6';
                        }
                    } else {
                        icon.textContent = 'â‡…';
                        icon.style.color = '';
                    }
                }
            });
        }

        function sortData(data) {
            if (!sortColumn || sortDirection === 'none') {
                return data;
            }
            
            return data.slice().sort(function(a, b) {
                let valA, valB;
                
                if (sortColumn === 'laki' || sortColumn === 'perempuan' || sortColumn === 'total') {
                    valA = a[sortColumn];
                    valB = b[sortColumn];
                } else {
                    valA = a[sortColumn].toString().toLowerCase();
                    valB = b[sortColumn].toString().toLowerCase();
                }
                
                let comparison = 0;
                if (valA > valB) {
                    comparison = 1;
                } else if (valA < valB) {
                    comparison = -1;
                }
                
                return sortDirection === 'asc' ? comparison : -comparison;
            });
        }

        async function fetchData() {
            try {
                const sheetId = '1IZkH2U4wGch0qUk1jn4q7CUWfsG6GxtrqD9kBsKN-HY';
                const gid = '198957752';
                const url = 'https://docs.google.com/spreadsheets/d/' + sheetId + '/gviz/tq?tqx=out:json&gid=' + gid;
                
                const response = await fetch(url);
                const text = await response.text();
                const json = JSON.parse(text.substr(47).slice(0, -2));
                
                const rows = json.table.rows;
                const namaBulan = monthNames;
                
                rawData = rows.map(function(row) {
                    const periodeRaw = row.c[0]?.v || '';
                    let bulan = '';
                    let tahunFromPeriode = 0;
                    let periodeText = '';
                    
                    if (typeof periodeRaw === 'string' && periodeRaw.startsWith('Date(')) {
                        const dateMatch = periodeRaw.match(/Date\((\d+),(\d+),(\d+)\)/);
                        if (dateMatch) {
                            const year = parseInt(dateMatch[1]);
                            const monthIndex = parseInt(dateMatch[2]);
                            bulan = namaBulan[monthIndex];
                            tahunFromPeriode = year;
                            periodeText = bulan + ' ' + year;
                        }
                    } else {
                        const periodeParts = periodeRaw.toString().trim().split(/\s+/);
                        bulan = periodeParts[0] || '';
                        tahunFromPeriode = parseInt(periodeParts[1]) || 0;
                        periodeText = periodeRaw.toString().trim().replace(/\s+/g, ' ');
                    }
                    
                    return {
                        periode: periodeText,
                        bulan: bulan,
                        tahunPeriode: tahunFromPeriode,
                        pelayanan: (row.c[1]?.v || '').toString().trim(),
                        jaminan: (row.c[2]?.v || '').toString().trim(),
                        kelamin: (row.c[3]?.v || '').toString().trim(),
                        jumlah: parseInt(row.c[4]?.v || 0),
                        jenisPelayanan: (row.c[5]?.v || '').toString().trim(),
                        caraBayar: (row.c[6]?.v || '').toString().trim(),
                        tahun: parseInt(row.c[7]?.v || 0) || tahunFromPeriode
                    };
                }).filter(function(d) { return d.periode && d.jumlah > 0; });
                
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                
                initializeFilters();
                applyFilters();
            } catch (error) {
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('error-state').classList.remove('hidden');
                document.getElementById('error-message').textContent = 'Error: ' + error.message;
            }
        }

        function initializeFilters() {
            const tahunSet = [...new Set(rawData.map(function(d) { return d.tahun; }))].filter(function(t) { return t; }).sort(function(a, b) { return b - a; });
            selectedTahun = new Set(tahunSet);
            const optionsTahun = document.getElementById('options-tahun');
            optionsTahun.innerHTML = '';
            tahunSet.forEach(function(tahun) {
                const div = document.createElement('div');
                div.className = 'filter-option';
                div.onclick = function(e) {
                    e.stopPropagation();
                    const checkbox = this.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    toggleFilterOption('tahun', tahun, e);
                };
                div.innerHTML = '<input type="checkbox" id="check-tahun-' + tahun + '" value="' + tahun + '" checked><label class="cursor-pointer">' + tahun + '</label>';
                optionsTahun.appendChild(div);
            });
            
            selectedBulan = new Set(monthNames);
            const optionsBulan = document.getElementById('options-bulan');
            optionsBulan.innerHTML = '';
            monthNames.forEach(function(bulan) {
                const div = document.createElement('div');
                div.className = 'filter-option';
                div.onclick = function(e) {
                    e.stopPropagation();
                    const checkbox = this.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    toggleFilterOption('bulan', bulan, e);
                };
                div.innerHTML = '<input type="checkbox" id="check-bulan-' + bulan + '" value="' + bulan + '" checked><label class="cursor-pointer">' + bulan + '</label>';
                optionsBulan.appendChild(div);
            });
            
            const klinikSet = [...new Set(rawData.map(function(d) { return d.pelayanan; }))].filter(function(p) { return p; }).sort();
            selectedKlinik = new Set(klinikSet);
            const optionsKlinik = document.getElementById('options-klinik');
            optionsKlinik.innerHTML = '';
            klinikSet.forEach(function(klinik, idx) {
                const div = document.createElement('div');
                div.className = 'filter-option';
                div.onclick = function(e) {
                    e.stopPropagation();
                    const checkbox = this.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    toggleFilterOption('klinik', klinik, e);
                };
                div.innerHTML = '<input type="checkbox" id="check-klinik-' + idx + '" value="' + klinik + '" checked><label class="cursor-pointer">' + klinik + '</label>';
                optionsKlinik.appendChild(div);
            });
            
            const pelayananSet = [...new Set(rawData.map(function(d) { return d.jenisPelayanan; }))].filter(function(p) { return p; }).sort();
            selectedPelayanan = new Set(pelayananSet);
            const optionsPelayanan = document.getElementById('options-pelayanan');
            optionsPelayanan.innerHTML = '';
            pelayananSet.forEach(function(pelayanan) {
                const div = document.createElement('div');
                div.className = 'filter-option';
                div.onclick = function(e) {
                    e.stopPropagation();
                    const checkbox = this.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    toggleFilterOption('pelayanan', pelayanan, e);
                };
                div.innerHTML = '<input type="checkbox" id="check-pelayanan-' + pelayanan + '" value="' + pelayanan + '" checked><label class="cursor-pointer">' + pelayanan + '</label>';
                optionsPelayanan.appendChild(div);
            });
            
            const kelaminSet = [...new Set(rawData.map(function(d) { return d.kelamin; }))].filter(function(k) { return k; }).sort();
            selectedKelamin = new Set(kelaminSet);
            const optionsKelamin = document.getElementById('options-kelamin');
            optionsKelamin.innerHTML = '';
            kelaminSet.forEach(function(kelamin) {
                const div = document.createElement('div');
                div.className = 'filter-option';
                div.onclick = function(e) {
                    e.stopPropagation();
                    const checkbox = this.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    toggleFilterOption('kelamin', kelamin, e);
                };
                div.innerHTML = '<input type="checkbox" id="check-kelamin-' + kelamin + '" value="' + kelamin + '" checked><label class="cursor-pointer">' + kelamin + '</label>';
                optionsKelamin.appendChild(div);
            });
            
            document.getElementById('toggle-values').addEventListener('change', function() {
                updateCurrentTab();
            });
            
            document.getElementById('search-table').addEventListener('input', function(e) {
                searchQuery = e.target.value;
                currentPage = 1;
                updateTable();
            });
            
            document.getElementById('btn-prev').addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    updateTable();
                }
            });
            
            document.getElementById('btn-next').addEventListener('click', function() {
                const totalPages = Math.ceil(filteredData.length / ITEMS_PER_PAGE);
                if (currentPage < totalPages) {
                    currentPage++;
                    updateTable();
                }
            });
        }

        function applyFilters() {
            filteredData = rawData.filter(function(d) {
                const tahunMatch = selectedTahun.size === 0 || selectedTahun.has(d.tahun);
                const bulanMatch = selectedBulan.size === 0 || selectedBulan.has(d.bulan);
                const klinikMatch = selectedKlinik.size === 0 || selectedKlinik.has(d.pelayanan);
                const pelayananMatch = selectedPelayanan.size === 0 || selectedPelayanan.has(d.jenisPelayanan);
                const kelaminMatch = selectedKelamin.size === 0 || selectedKelamin.has(d.kelamin);
                
                return tahunMatch && bulanMatch && klinikMatch && pelayananMatch && kelaminMatch;
            });
            
            currentPage = 1;
            updateCurrentTab();
        }

        function switchTab(tabName) {
            currentTab = tabName;
            
            document.querySelectorAll('.tab-button').forEach(function(btn) {
                btn.classList.remove('active');
            });
            document.getElementById('tab-' + tabName).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(function(content) {
                content.classList.remove('active');
            });
            document.getElementById('content-' + tabName).classList.add('active');
            
            updateCurrentTab();
        }

        function updateCurrentTab() {
            if (currentTab === 'overview') {
                updateOverviewTab();
            } else if (currentTab === 'pelayanan') {
                updatePelayananTab();
            } else if (currentTab === 'status') {
                updateStatusTab();
            } else if (currentTab === 'analisa') {
                updateAnalisaTab();
            }
        }

        function updateOverviewTab() {
            updateKPIs();
            updateTrendChart();
            updateKlinikChart();
            updateServiceCharts();
            updateGenderChart();
            updateBayarChart();
            updateOverviewTable();
            updateTable();
        }

        function updateKPIs() {
            const total = filteredData.reduce(function(sum, d) { return sum + d.jumlah; }, 0);
            const poliklinik = filteredData.filter(function(d) { return d.jenisPelayanan === 'Poliklinik'; }).reduce(function(sum, d) { return sum + d.jumlah; }, 0);
            const mcu = filteredData.filter(function(d) { return d.jenisPelayanan === 'MCU'; }).reduce(function(sum, d) { return sum + d.jumlah; }, 0);
            const igd = filteredData.filter(function(d) { return d.jenisPelayanan === 'IGD'; }).reduce(function(sum, d) { return sum + d.jumlah; }, 0);
            const ri = filteredData.filter(function(d) { return d.jenisPelayanan === 'RI'; }).reduce(function(sum, d) { return sum + d.jumlah; }, 0);
            
            animateCounter(document.getElementById('kpi-total'), total);
            animateCounter(document.getElementById('kpi-poliklinik'), poliklinik);
            animateCounter(document.getElementById('kpi-mcu'), mcu);
            animateCounter(document.getElementById('kpi-igd'), igd);
            animateCounter(document.getElementById('kpi-rawat-inap'), ri);
        }

        function updateTrendChart() {
            const ctx = document.getElementById('chart-tren').getContext('2d');
            const showValues = document.getElementById('toggle-values').checked;
            const chartType = chartTypes['chart-tren'] || 'line';
            
            const periodeData = {};
            filteredData.forEach(function(d) {
                periodeData[d.periode] = (periodeData[d.periode] || 0) + d.jumlah;
            });
            
            const sorted = Object.entries(periodeData).sort(function(a, b) {
                const bulanA = a[0].split(' ')[0];
                const tahunA = a[0].split(' ')[1];
                const bulanB = b[0].split(' ')[0];
                const tahunB = b[0].split(' ')[1];
                if (tahunA !== tahunB) return parseInt(tahunA) - parseInt(tahunB);
                return monthOrder[bulanA] - monthOrder[bulanB];
            });
            
            if (charts.tren) charts.tren.destroy();
            
            charts.tren = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: sorted.map(function(item) { return item[0]; }),
                    datasets: [{
                        label: 'Kunjungan',
                        data: sorted.map(function(item) { return item[1]; }),
                        borderColor: '#3B82F6',
                        backgroundColor: chartType === 'line' ? '#3B82F633' : '#3B82F6',
                        tension: 0.4,
                        fill: chartType === 'line'
                    }]
                },
                options: getEnhancedChartOptions(showValues, chartType)
            });
        }

        function updateKlinikChart() {
            const ctx = document.getElementById('chart-klinik').getContext('2d');
            const showValues = document.getElementById('toggle-values').checked;
            const chartType = chartTypes['chart-klinik'] || 'line';
            
            const klinikData = {};
            filteredData.forEach(function(d) {
                klinikData[d.pelayanan] = (klinikData[d.pelayanan] || 0) + d.jumlah;
            });
            
            const sorted = Object.entries(klinikData).sort(function(a, b) { return b[1] - a[1]; }).slice(0, 10);
            
            if (charts.klinik) charts.klinik.destroy();
            
            charts.klinik = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: sorted.map(function(item) { return item[0]; }),
                    datasets: [{
                        label: 'Kunjungan',
                        data: sorted.map(function(item) { return item[1]; }),
                        borderColor: '#10B981',
                        backgroundColor: chartType === 'line' ? '#10B98133' : '#10B981',
                        tension: 0.4,
                        fill: chartType === 'line'
                    }]
                },
                options: getEnhancedChartOptions(showValues, chartType)
            });
        }

        function updateServiceCharts() {
            const showValues = document.getElementById('toggle-values').checked;
            const services = [
                { name: 'Poliklinik', chartId: 'chart-poliklinik', color: '#3B82F6', badgePrefix: 'poliklinik' },
                { name: 'MCU', chartId: 'chart-mcu', color: '#8B5CF6', badgePrefix: 'mcu' },
                { name: 'IGD', chartId: 'chart-igd', color: '#EF4444', badgePrefix: 'igd' },
                { name: 'RI', chartId: 'chart-ri', color: '#F59E0B', badgePrefix: 'ri' }
            ];
            
            services.forEach(function(service) {
                const chartType = chartTypes[service.chartId] || 'line';
                
                const serviceData = filteredData.filter(function(d) {
                    return d.jenisPelayanan === service.name;
                });
                
                // Group by periode and gender
                const periodeGenderData = {};
                
                serviceData.forEach(function(d) {
                    if (!periodeGenderData[d.periode]) {
                        periodeGenderData[d.periode] = { L: 0, P: 0, total: 0 };
                    }
                    if (d.kelamin === 'L' || d.kelamin === 'Laki-laki') {
                        periodeGenderData[d.periode].L += d.jumlah;
                    } else if (d.kelamin === 'P' || d.kelamin === 'Perempuan') {
                        periodeGenderData[d.periode].P += d.jumlah;
                    }
                    periodeGenderData[d.periode].total += d.jumlah;
                });
                
                // Sort periods
                const sortedPeriodes = Object.keys(periodeGenderData).sort(function(a, b) {
                    const bulanA = a.split(' ')[0];
                    const tahunA = a.split(' ')[1];
                    const bulanB = b.split(' ')[0];
                    const tahunB = b.split(' ')[1];
                    if (tahunA !== tahunB) return parseInt(tahunA) - parseInt(tahunB);
                    return monthOrder[bulanA] - monthOrder[bulanB];
                });
                
                // Prepare chart data - total only
                const totalData = sortedPeriodes.map(function(p) { return periodeGenderData[p].total; });
                
                // Calculate totals for badges
                const totalLakiLaki = sortedPeriodes.reduce(function(sum, p) { return sum + periodeGenderData[p].L; }, 0);
                const totalPerempuan = sortedPeriodes.reduce(function(sum, p) { return sum + periodeGenderData[p].P; }, 0);
                const grandTotal = totalLakiLaki + totalPerempuan;
                const percentL = grandTotal > 0 ? ((totalLakiLaki / grandTotal) * 100).toFixed(1) : 0;
                const percentP = grandTotal > 0 ? ((totalPerempuan / grandTotal) * 100).toFixed(1) : 0;
                
                // Update badges with icons
                document.getElementById('badge-' + service.badgePrefix + '-total').textContent = 'Total: ' + grandTotal.toLocaleString('id-ID');
                document.getElementById('badge-' + service.badgePrefix + '-l').innerHTML = 'ğŸ‘¨ L: ' + totalLakiLaki.toLocaleString('id-ID') + ' (' + percentL + '%)';
                document.getElementById('badge-' + service.badgePrefix + '-p').innerHTML = 'ğŸ‘© P: ' + totalPerempuan.toLocaleString('id-ID') + ' (' + percentP + '%)';
                
                // Update toggle button text
                const button = document.getElementById('btn-toggle-' + service.chartId);
                if (button) {
                    if (chartType === 'bar') {
                        button.innerHTML = 'ğŸ“ˆ Line';
                    } else {
                        button.innerHTML = 'ğŸ“Š Bar';
                    }
                }
                
                const ctx = document.getElementById(service.chartId).getContext('2d');
                
                if (charts[service.chartId]) charts[service.chartId].destroy();
                
                charts[service.chartId] = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: sortedPeriodes,
                        datasets: [
                            {
                                label: 'Total Kunjungan',
                                data: totalData,
                                backgroundColor: chartType === 'line' ? service.color + '33' : service.color,
                                borderColor: service.color,
                                borderWidth: 2,
                                tension: 0.4,
                                fill: chartType === 'line'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { 
                                display: false
                            },
                            datalabels: {
                                display: showValues,
                                anchor: 'end',
                                align: 'top',
                                color: '#000',
                                font: { weight: 'bold', size: 10 },
                                formatter: function(v) { return v > 0 ? v.toLocaleString('id-ID') : ''; }
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                callbacks: {
                                    title: function(context) {
                                        return 'Periode: ' + context[0].label;
                                    },
                                    label: function(context) {
                                        const idx = context.dataIndex;
                                        const periode = sortedPeriodes[idx];
                                        const data = periodeGenderData[periode];
                                        return 'Total: ' + data.total.toLocaleString('id-ID');
                                    },
                                    afterLabel: function(context) {
                                        const idx = context.dataIndex;
                                        const periode = sortedPeriodes[idx];
                                        const data = periodeGenderData[periode];
                                        const percentL = data.total > 0 ? ((data.L / data.total) * 100).toFixed(1) : 0;
                                        const percentP = data.total > 0 ? ((data.P / data.total) * 100).toFixed(1) : 0;
                                        return [
                                            'ğŸ‘¨ Laki-laki: ' + data.L.toLocaleString('id-ID') + ' (' + percentL + '%)',
                                            'ğŸ‘© Perempuan: ' + data.P.toLocaleString('id-ID') + ' (' + percentP + '%)'
                                        ];
                                    }
                                }
                            }
                        },
                        scales: { 
                            y: { 
                                beginAtZero: true,
                                ticks: { font: { size: 10 } }
                            },
                            x: {
                                ticks: { 
                                    font: { size: 9 },
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            });
        }

        function updateGenderChart() {
            const ctx = document.getElementById('chart-gender').getContext('2d');
            const showValues = document.getElementById('toggle-values').checked;
            
            const genderData = {};
            filteredData.forEach(function(d) {
                genderData[d.kelamin] = (genderData[d.kelamin] || 0) + d.jumlah;
            });
            
            const labels = Object.keys(genderData);
            const data = labels.map(function(k) { return genderData[k]; });
            
            if (charts.gender) charts.gender.destroy();
            
            charts.gender = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#3B82F6', '#EC4899', '#8B5CF6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        datalabels: {
                            display: showValues,
                            color: '#fff',
                            font: { weight: 'bold', size: 14 },
                            formatter: function(v) { return v.toLocaleString('id-ID'); }
                        },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': ' + context.parsed.toLocaleString('id-ID') + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateBayarChart() {
            const ctx = document.getElementById('chart-bayar').getContext('2d');
            const showValues = document.getElementById('toggle-values').checked;
            
            const bayarData = {};
            filteredData.forEach(function(d) {
                bayarData[d.caraBayar] = (bayarData[d.caraBayar] || 0) + d.jumlah;
            });
            
            const sorted = Object.entries(bayarData).sort(function(a, b) { return b[1] - a[1]; });
            
            if (charts.bayar) charts.bayar.destroy();
            
            charts.bayar = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(function(item) { return item[0]; }),
                    datasets: [{
                        label: 'Kunjungan',
                        data: sorted.map(function(item) { return item[1]; }),
                        backgroundColor: '#8B5CF6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            display: showValues,
                            anchor: 'end',
                            align: 'right',
                            font: { weight: 'bold', size: 11 },
                            formatter: function(v) { return v.toLocaleString('id-ID'); }
                        },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed.x / total) * 100).toFixed(1);
                                    return 'Jumlah: ' + context.parsed.x.toLocaleString('id-ID') + ' (' + percentage + '%)';
                                }
                            }
                        }
                    },
                    scales: { x: { beginAtZero: true } }
                }
            });
        }

        function updateOverviewTable() {
            const jenisData = {};
            filteredData.forEach(function(d) {
                jenisData[d.jenisPelayanan] = (jenisData[d.jenisPelayanan] || 0) + d.jumlah;
            });
            
            const sorted = Object.entries(jenisData).sort(function(a, b) { return b[1] - a[1]; });
            const total = sorted.reduce(function(sum, item) { return sum + item[1]; }, 0);
            
            const tbody = document.getElementById('table-overview-body');
            tbody.innerHTML = '';
            
            sorted.forEach(function(item) {
                const jenis = item[0];
                const jumlah = item[1];
                const persen = total > 0 ? ((jumlah / total) * 100).toFixed(1) : 0;
                tbody.innerHTML += '<tr class="hover:bg-gray-50"><td class="px-3 sm:px-4 py-3 text-sm text-gray-900">' + jenis + '</td><td class="px-3 sm:px-4 py-3 text-sm text-gray-900 text-right font-medium">' + jumlah.toLocaleString('id-ID') + '</td><td class="px-3 sm:px-4 py-3 text-sm text-gray-900 text-right">' + persen + '%</td></tr>';
            });
            
            document.getElementById('total-overview').textContent = total.toLocaleString('id-ID');
        }

        function updateTable() {
            const searchLower = searchQuery.toLowerCase();
            
            // Group data based on visible columns
            const groupedData = {};
            
            filteredData.forEach(function(d) {
                // Build key based on visible columns
                let keyParts = [];
                if (visibleColumns.periode) keyParts.push(d.periode);
                if (visibleColumns.jenis) keyParts.push(d.jenisPelayanan);
                if (visibleColumns.klinik) keyParts.push(d.pelayanan);
                if (visibleColumns.status) keyParts.push(d.jaminan);
                if (visibleColumns.bayar) keyParts.push(d.caraBayar);
                
                const key = keyParts.join('|');
                
                if (!groupedData[key]) {
                    groupedData[key] = {
                        periode: d.periode,
                        jenis: d.jenisPelayanan,
                        klinik: d.pelayanan,
                        status: d.jaminan,
                        bayar: d.caraBayar,
                        laki: 0,
                        perempuan: 0,
                        total: 0
                    };
                }
                
                if (d.kelamin === 'L' || d.kelamin === 'Laki-laki') {
                    groupedData[key].laki += d.jumlah;
                } else if (d.kelamin === 'P' || d.kelamin === 'Perempuan') {
                    groupedData[key].perempuan += d.jumlah;
                }
                groupedData[key].total += d.jumlah;
            });
            
            let displayData = Object.values(groupedData);
            
            // Apply search filter
            if (searchQuery) {
                displayData = displayData.filter(function(d) {
                    return d.periode.toLowerCase().includes(searchLower) ||
                           d.jenis.toLowerCase().includes(searchLower) ||
                           d.klinik.toLowerCase().includes(searchLower) ||
                           d.status.toLowerCase().includes(searchLower) ||
                           d.bayar.toLowerCase().includes(searchLower);
                });
            }
            
            // Apply sorting
            displayData = sortData(displayData);
            
            // Calculate totals from ALL filtered data
            const totalLaki = displayData.reduce(function(sum, d) { return sum + d.laki; }, 0);
            const totalPerempuan = displayData.reduce(function(sum, d) { return sum + d.perempuan; }, 0);
            const grandTotal = displayData.reduce(function(sum, d) { return sum + d.total; }, 0);
            
            document.getElementById('footer-laki').textContent = totalLaki.toLocaleString('id-ID');
            document.getElementById('footer-perempuan').textContent = totalPerempuan.toLocaleString('id-ID');
            document.getElementById('footer-total').textContent = grandTotal.toLocaleString('id-ID');
            
            const totalItems = displayData.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageData = displayData.slice(start, end);
            
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            pageData.forEach(function(d, index) {
                const rowNumber = start + index + 1;
                let row = '<tr class="hover:bg-gray-50">';
                row += '<td class="px-3 sm:px-4 py-3 text-sm text-gray-900 text-center">' + rowNumber + '</td>';
                if (visibleColumns.periode) row += '<td class="px-3 sm:px-4 py-3 text-sm text-gray-900 col-periode">' + d.periode + '</td>';
                if (visibleColumns.jenis) row += '<td class="px-3 sm:px-4 py-3 text-sm text-gray-900 col-jenis">' + d.jenis + '</td>';
                if (visibleColumns.klinik) row += '<td class="px-3 sm:px-4 py-3 text-sm text-gray-900 col-klinik">' + d.klinik + '</td>';
                if (visibleColumns.status) row += '<td class="px-3 sm:px-4 py-3 text-sm text-gray-900 col-status">' + d.status + '</td>';
                if (visibleColumns.bayar) row += '<td class="px-3 sm:px-4 py-3 text-sm text-gray-900 col-bayar">' + d.bayar + '</td>';
                if (visibleColumns.laki) row += '<td class="px-3 sm:px-4 py-3 text-sm text-gray-900 text-right font-medium col-laki">' + d.laki.toLocaleString('id-ID') + '</td>';
                if (visibleColumns.perempuan) row += '<td class="px-3 sm:px-4 py-3 text-sm text-gray-900 text-right font-medium col-perempuan">' + d.perempuan.toLocaleString('id-ID') + '</td>';
                if (visibleColumns.total) row += '<td class="px-3 sm:px-4 py-3 text-sm text-gray-900 text-right font-bold col-total">' + d.total.toLocaleString('id-ID') + '</td>';
                row += '</tr>';
                tbody.innerHTML += row;
            });
            
            document.getElementById('table-info').textContent = totalItems > 0 ? (start + 1) + '-' + Math.min(end, totalItems) + ' dari ' + totalItems + ' data' : '0 data';
            
            document.getElementById('btn-prev').disabled = currentPage === 1;
            document.getElementById('btn-next').disabled = currentPage >= totalPages;
        }

        function toggleColumn(columnName) {
            visibleColumns[columnName] = !visibleColumns[columnName];
            
            // Toggle column visibility in header
            const headerCols = document.querySelectorAll('.col-' + columnName);
            headerCols.forEach(function(col) {
                col.style.display = visibleColumns[columnName] ? '' : 'none';
            });
            
            // Update footer colspan
            updateFooterColspan();
            
            // Refresh table
            updateTable();
        }

        function updateFooterColspan() {
            const firstFooterCell = document.querySelector('#detail-table-footer td:first-child');
            
            // Count visible columns before laki-laki (plus 1 for No column)
            let colspanCount = 1; // Start with 1 for No column
            if (visibleColumns.periode) colspanCount++;
            if (visibleColumns.jenis) colspanCount++;
            if (visibleColumns.klinik) colspanCount++;
            if (visibleColumns.status) colspanCount++;
            if (visibleColumns.bayar) colspanCount++;
            
            if (colspanCount > 0) {
                firstFooterCell.setAttribute('colspan', colspanCount);
            } else {
                firstFooterCell.removeAttribute('colspan');
            }
        }

        function changeItemsPerPage() {
            ITEMS_PER_PAGE = parseInt(document.getElementById('items-per-page').value);
            currentPage = 1;
            updateTable();
        }

        function exportDetailToCSV() {
            // Group data based on visible columns
            const groupedData = {};
            
            filteredData.forEach(function(d) {
                let keyParts = [];
                if (visibleColumns.periode) keyParts.push(d.periode);
                if (visibleColumns.jenis) keyParts.push(d.jenisPelayanan);
                if (visibleColumns.klinik) keyParts.push(d.pelayanan);
                if (visibleColumns.status) keyParts.push(d.jaminan);
                if (visibleColumns.bayar) keyParts.push(d.caraBayar);
                
                const key = keyParts.join('|');
                
                if (!groupedData[key]) {
                    groupedData[key] = {
                        periode: d.periode,
                        jenis: d.jenisPelayanan,
                        klinik: d.pelayanan,
                        status: d.jaminan,
                        bayar: d.caraBayar,
                        laki: 0,
                        perempuan: 0,
                        total: 0
                    };
                }
                
                if (d.kelamin === 'L' || d.kelamin === 'Laki-laki') {
                    groupedData[key].laki += d.jumlah;
                } else if (d.kelamin === 'P' || d.kelamin === 'Perempuan') {
                    groupedData[key].perempuan += d.jumlah;
                }
                groupedData[key].total += d.jumlah;
            });
            
            let displayData = Object.values(groupedData);
            
            // Apply sorting if active
            displayData = sortData(displayData);
            
            let csv = [];
            let headers = ['No'];
            
            if (visibleColumns.periode) headers.push('Periode');
            if (visibleColumns.jenis) headers.push('Jenis Pelayanan');
            if (visibleColumns.klinik) headers.push('Klinik');
            if (visibleColumns.status) headers.push('Status');
            if (visibleColumns.bayar) headers.push('Cara Bayar');
            if (visibleColumns.laki) headers.push('Laki-laki');
            if (visibleColumns.perempuan) headers.push('Perempuan');
            if (visibleColumns.total) headers.push('Total');
            
            csv.push(headers);
            
            displayData.forEach(function(d, index) {
                let row = [index + 1];
                if (visibleColumns.periode) row.push(d.periode);
                if (visibleColumns.jenis) row.push(d.jenis);
                if (visibleColumns.klinik) row.push(d.klinik);
                if (visibleColumns.status) row.push(d.status);
                if (visibleColumns.bayar) row.push(d.bayar);
                if (visibleColumns.laki) row.push(d.laki);
                if (visibleColumns.perempuan) row.push(d.perempuan);
                if (visibleColumns.total) row.push(d.total);
                csv.push(row);
            });
            
            // Add totals
            const totalLaki = displayData.reduce(function(sum, d) { return sum + d.laki; }, 0);
            const totalPerempuan = displayData.reduce(function(sum, d) { return sum + d.perempuan; }, 0);
            const grandTotal = displayData.reduce(function(sum, d) { return sum + d.total; }, 0);
            
            let totalRow = ['TOTAL'];
            if (visibleColumns.periode) totalRow.push('');
            if (visibleColumns.jenis) totalRow.push('');
            if (visibleColumns.klinik) totalRow.push('');
            if (visibleColumns.status) totalRow.push('');
            if (visibleColumns.bayar) totalRow.push('');
            if (visibleColumns.laki) totalRow.push(totalLaki);
            if (visibleColumns.perempuan) totalRow.push(totalPerempuan);
            if (visibleColumns.total) totalRow.push(grandTotal);
            
            csv.push(totalRow);
            
            const csvContent = csv.map(function(row) { return row.join(','); }).join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'data_detail_' + new Date().getTime() + '.csv';
            link.click();
        }

        function exportDetailToPDF() {
            // Group data based on visible columns
            const groupedData = {};
            
            filteredData.forEach(function(d) {
                let keyParts = [];
                if (visibleColumns.periode) keyParts.push(d.periode);
                if (visibleColumns.jenis) keyParts.push(d.jenisPelayanan);
                if (visibleColumns.klinik) keyParts.push(d.pelayanan);
                if (visibleColumns.status) keyParts.push(d.jaminan);
                if (visibleColumns.bayar) keyParts.push(d.caraBayar);
                
                const key = keyParts.join('|');
                
                if (!groupedData[key]) {
                    groupedData[key] = {
                        periode: d.periode,
                        jenis: d.jenisPelayanan,
                        klinik: d.pelayanan,
                        status: d.jaminan,
                        bayar: d.caraBayar,
                        laki: 0,
                        perempuan: 0,
                        total: 0
                    };
                }
                
                if (d.kelamin === 'L' || d.kelamin === 'Laki-laki') {
                    groupedData[key].laki += d.jumlah;
                } else if (d.kelamin === 'P' || d.kelamin === 'Perempuan') {
                    groupedData[key].perempuan += d.jumlah;
                }
                groupedData[key].total += d.jumlah;
            });
            
            let displayData = Object.values(groupedData);
            
            // Apply sorting if active
            displayData = sortData(displayData);
            
            let tableHTML = '<table border="1" cellpadding="5" cellspacing="0" style="border-collapse:collapse;width:100%;font-size:10px;"><thead><tr style="background-color:#f3f4f6;">';
            
            tableHTML += '<th>No</th>';
            if (visibleColumns.periode) tableHTML += '<th>Periode</th>';
            if (visibleColumns.jenis) tableHTML += '<th>Jenis Pelayanan</th>';
            if (visibleColumns.klinik) tableHTML += '<th>Klinik</th>';
            if (visibleColumns.status) tableHTML += '<th>Status</th>';
            if (visibleColumns.bayar) tableHTML += '<th>Cara Bayar</th>';
            if (visibleColumns.laki) tableHTML += '<th>Laki-laki</th>';
            if (visibleColumns.perempuan) tableHTML += '<th>Perempuan</th>';
            if (visibleColumns.total) tableHTML += '<th>Total</th>';
            
            tableHTML += '</tr></thead><tbody>';
            
            displayData.forEach(function(d, index) {
                tableHTML += '<tr>';
                tableHTML += '<td style="text-align:center;">' + (index + 1) + '</td>';
                if (visibleColumns.periode) tableHTML += '<td>' + d.periode + '</td>';
                if (visibleColumns.jenis) tableHTML += '<td>' + d.jenis + '</td>';
                if (visibleColumns.klinik) tableHTML += '<td>' + d.klinik + '</td>';
                if (visibleColumns.status) tableHTML += '<td>' + d.status + '</td>';
                if (visibleColumns.bayar) tableHTML += '<td>' + d.bayar + '</td>';
                if (visibleColumns.laki) tableHTML += '<td style="text-align:right;">' + d.laki.toLocaleString('id-ID') + '</td>';
                if (visibleColumns.perempuan) tableHTML += '<td style="text-align:right;">' + d.perempuan.toLocaleString('id-ID') + '</td>';
                if (visibleColumns.total) tableHTML += '<td style="text-align:right;font-weight:bold;">' + d.total.toLocaleString('id-ID') + '</td>';
                tableHTML += '</tr>';
            });
            
            // Add totals
            const totalLaki = displayData.reduce(function(sum, d) { return sum + d.laki; }, 0);
            const totalPerempuan = displayData.reduce(function(sum, d) { return sum + d.perempuan; }, 0);
            const grandTotal = displayData.reduce(function(sum, d) { return sum + d.total; }, 0);
            
            let colspanCount = 1;
            if (visibleColumns.periode) colspanCount++;
            if (visibleColumns.jenis) colspanCount++;
            if (visibleColumns.klinik) colspanCount++;
            if (visibleColumns.status) colspanCount++;
            if (visibleColumns.bayar) colspanCount++;
            
            tableHTML += '<tr style="background-color:#e5e7eb;font-weight:bold;">';
            tableHTML += '<td colspan="' + colspanCount + '">TOTAL KESELURUHAN</td>';
            if (visibleColumns.laki) tableHTML += '<td style="text-align:right;">' + totalLaki.toLocaleString('id-ID') + '</td>';
            if (visibleColumns.perempuan) tableHTML += '<td style="text-align:right;">' + totalPerempuan.toLocaleString('id-ID') + '</td>';
            if (visibleColumns.total) tableHTML += '<td style="text-align:right;">' + grandTotal.toLocaleString('id-ID') + '</td>';
            tableHTML += '</tr>';
            
            tableHTML += '</tbody></table>';
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Data Detail Kunjungan Pasien</title><style>body { margin: 0; padding: 20px; font-family: Arial, sans-serif; } h2 { text-align: center; margin-bottom: 20px; } @media print { body { padding: 10px; } }</style></head><body><h2>Data Detail Kunjungan Pasien</h2>' + tableHTML + '<script>window.onload = function() { window.print(); }<\/script></body></html>');
            printWindow.document.close();
        }

        function updatePelayananTab() {
            const showValues = document.getElementById('toggle-values').checked;
            const chartTypeJenis = chartTypes['chart-pelayanan-jenis'] || 'line';
            const chartTypeKlinik = chartTypes['chart-pelayanan-klinik'] || 'line';
            
            const jenisData = {};
            filteredData.forEach(function(d) {
                jenisData[d.jenisPelayanan] = (jenisData[d.jenisPelayanan] || 0) + d.jumlah;
            });
            
            const sortedJenis = Object.entries(jenisData).sort(function(a, b) { return b[1] - a[1]; });
            const totalJenis = sortedJenis.reduce(function(sum, item) { return sum + item[1]; }, 0);
            
            const ctxJenis = document.getElementById('chart-pelayanan-jenis').getContext('2d');
            if (charts.pelayananJenis) charts.pelayananJenis.destroy();
            
            charts.pelayananJenis = new Chart(ctxJenis, {
                type: chartTypeJenis,
                data: {
                    labels: sortedJenis.map(function(item) { return item[0]; }),
                    datasets: [{
                        label: 'Kunjungan',
                        data: sortedJenis.map(function(item) { return item[1]; }),
                        borderColor: '#10B981',
                        backgroundColor: chartTypeJenis === 'line' ? '#10B98133' : '#10B981',
                        tension: 0.4,
                        fill: chartTypeJenis === 'line'
                    }]
                },
                options: getEnhancedChartOptions(showValues, chartTypeJenis)
            });
            
            const klinikData = {};
            filteredData.forEach(function(d) {
                klinikData[d.pelayanan] = (klinikData[d.pelayanan] || 0) + d.jumlah;
            });
            
            const sortedKlinik = Object.entries(klinikData).sort(function(a, b) { return b[1] - a[1]; }).slice(0, 15);
            const totalKlinik = Object.values(klinikData).reduce(function(sum, v) { return sum + v; }, 0);
            
            const ctxKlinik = document.getElementById('chart-pelayanan-klinik').getContext('2d');
            if (charts.pelayananKlinik) charts.pelayananKlinik.destroy();
            
            charts.pelayananKlinik = new Chart(ctxKlinik, {
                type: chartTypeKlinik,
                data: {
                    labels: sortedKlinik.map(function(item) { return item[0]; }),
                    datasets: [{
                        label: 'Kunjungan',
                        data: sortedKlinik.map(function(item) { return item[1]; }),
                        borderColor: '#3B82F6',
                        backgroundColor: chartTypeKlinik === 'line' ? '#3B82F633' : '#3B82F6',
                        tension: 0.4,
                        fill: chartTypeKlinik === 'line'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: chartTypeKlinik === 'bar' ? 'y' : 'x',
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            display: showValues,
                            anchor: 'end',
                            align: chartTypeKlinik === 'bar' ? 'right' : 'top',
                            font: { weight: 'bold', size: 11 },
                            formatter: function(v) { return v.toLocaleString('id-ID'); }
                        },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                label: function(context) {
                                    const percentage = ((context.parsed.x / totalKlinik) * 100).toFixed(1);
                                    return context.label + ': ' + context.parsed.x.toLocaleString('id-ID') + ' (' + percentage + '%)';
                                }
                            }
                        }
                    },
                    scales: { 
                        x: { beginAtZero: true },
                        y: { beginAtZero: true }
                    }
                }
            });
            
            const tbodyJenis = document.getElementById('table-pelayanan-jenis-body');
            tbodyJenis.innerHTML = '';
            sortedJenis.forEach(function(item) {
                const jenis = item[0];
                const jumlah = item[1];
                const persen = ((jumlah / totalJenis) * 100).toFixed(1);
                tbodyJenis.innerHTML += '<tr class="hover:bg-gray-50"><td class="px-3 py-2 text-xs text-gray-900">' + jenis + '</td><td class="px-3 py-2 text-xs text-gray-900 text-right font-medium">' + jumlah.toLocaleString('id-ID') + '</td><td class="px-3 py-2 text-xs text-gray-900 text-right">' + persen + '%</td></tr>';
            });
            document.getElementById('total-pelayanan-jenis').textContent = totalJenis.toLocaleString('id-ID');
            
            const tbodyKlinik = document.getElementById('table-pelayanan-klinik-body');
            tbodyKlinik.innerHTML = '';
            Object.entries(klinikData).sort(function(a, b) { return b[1] - a[1]; }).forEach(function(item) {
                const klinik = item[0];
                const jumlah = item[1];
                const persen = ((jumlah / totalKlinik) * 100).toFixed(1);
                tbodyKlinik.innerHTML += '<tr class="hover:bg-gray-50"><td class="px-3 py-2 text-xs text-gray-900">' + klinik + '</td><td class="px-3 py-2 text-xs text-gray-900 text-right font-medium">' + jumlah.toLocaleString('id-ID') + '</td><td class="px-3 py-2 text-xs text-gray-900 text-right">' + persen + '%</td></tr>';
            });
            document.getElementById('total-pelayanan-klinik').textContent = totalKlinik.toLocaleString('id-ID');
        }

        function updateStatusTab() {
            const showValues = document.getElementById('toggle-values').checked;
            
            const bayarData = {};
            filteredData.forEach(function(d) {
                bayarData[d.caraBayar] = (bayarData[d.caraBayar] || 0) + d.jumlah;
            });
            
            const sortedBayar = Object.entries(bayarData).sort(function(a, b) { return b[1] - a[1]; });
            const totalBayar = sortedBayar.reduce(function(sum, item) { return sum + item[1]; }, 0);
            
            const ctxBayar = document.getElementById('chart-status-bayar').getContext('2d');
            if (charts.statusBayar) charts.statusBayar.destroy();
            
            charts.statusBayar = new Chart(ctxBayar, {
                type: 'pie',
                data: {
                    labels: sortedBayar.map(function(item) { return item[0]; }),
                    datasets: [{
                        data: sortedBayar.map(function(item) { return item[1]; }),
                        backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        datalabels: {
                            display: showValues,
                            color: '#fff',
                            font: { weight: 'bold', size: 14 },
                            formatter: function(v) { return v.toLocaleString('id-ID'); }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percentage = ((context.parsed / totalBayar) * 100).toFixed(1);
                                    return context.label + ': ' + context.parsed.toLocaleString('id-ID') + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
            
            const jaminanData = {};
            filteredData.forEach(function(d) {
                jaminanData[d.jaminan] = (jaminanData[d.jaminan] || 0) + d.jumlah;
            });
            
            const sortedJaminan = Object.entries(jaminanData).sort(function(a, b) { return b[1] - a[1]; });
            const totalJaminan = sortedJaminan.reduce(function(sum, item) { return sum + item[1]; }, 0);
            
            const ctxJaminan = document.getElementById('chart-status-jaminan').getContext('2d');
            if (charts.statusJaminan) charts.statusJaminan.destroy();
            
            charts.statusJaminan = new Chart(ctxJaminan, {
                type: 'doughnut',
                data: {
                    labels: sortedJaminan.map(function(item) { return item[0]; }),
                    datasets: [{
                        data: sortedJaminan.map(function(item) { return item[1]; }),
                        backgroundColor: ['#8B5CF6', '#EC4899', '#F59E0B', '#10B981', '#3B82F6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        datalabels: {
                            display: showValues,
                            color: '#fff',
                            font: { weight: 'bold', size: 14 },
                            formatter: function(v) { return v.toLocaleString('id-ID'); }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percentage = ((context.parsed / totalJaminan) * 100).toFixed(1);
                                    return context.label + ': ' + context.parsed.toLocaleString('id-ID') + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
            
            const tbodyBayar = document.getElementById('table-status-bayar-body');
            tbodyBayar.innerHTML = '';
            sortedBayar.forEach(function(item) {
                const cara = item[0];
                const jumlah = item[1];
                const persen = ((jumlah / totalBayar) * 100).toFixed(1);
                tbodyBayar.innerHTML += '<tr class="hover:bg-gray-50"><td class="px-3 py-2 text-xs text-gray-900">' + cara + '</td><td class="px-3 py-2 text-xs text-gray-900 text-right font-medium">' + jumlah.toLocaleString('id-ID') + '</td><td class="px-3 py-2 text-xs text-gray-900 text-right">' + persen + '%</td></tr>';
            });
            document.getElementById('total-status-bayar').textContent = totalBayar.toLocaleString('id-ID');
            
            const tbodyJaminan = document.getElementById('table-status-jaminan-body');
            tbodyJaminan.innerHTML = '';
            sortedJaminan.forEach(function(item) {
                const jaminan = item[0];
                const jumlah = item[1];
                const persen = ((jumlah / totalJaminan) * 100).toFixed(1);
                tbodyJaminan.innerHTML += '<tr class="hover:bg-gray-50"><td class="px-3 py-2 text-xs text-gray-900">' + jaminan + '</td><td class="px-3 py-2 text-xs text-gray-900 text-right font-medium">' + jumlah.toLocaleString('id-ID') + '</td><td class="px-3 py-2 text-xs text-gray-900 text-right">' + persen + '%</td></tr>';
            });
            document.getElementById('total-status-jaminan').textContent = totalJaminan.toLocaleString('id-ID');
        }

        function updateAnalisaTab() {
            const showValues = document.getElementById('toggle-values').checked;
            const chartType = chartTypes['chart-analisa'] || 'line';
            const selectedYears = [...selectedTahun].sort(function(a, b) { return a - b; });
            
            if (selectedYears.length === 0) {
                return;
            }
            
            const yearData = {};
            selectedYears.forEach(function(year) {
                yearData[year] = {};
                monthNames.forEach(function(month) {
                    yearData[year][month] = 0;
                });
            });
            
            filteredData.forEach(function(d) {
                if (selectedYears.includes(d.tahun) && yearData[d.tahun]) {
                    yearData[d.tahun][d.bulan] = (yearData[d.tahun][d.bulan] || 0) + d.jumlah;
                }
            });
            
            const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#6366F1', '#14B8A6'];
            const datasets = selectedYears.map(function(year, idx) {
                return {
                    label: year.toString(),
                    data: monthNames.map(function(m) { return yearData[year][m] || 0; }),
                    borderColor: colors[idx % colors.length],
                    backgroundColor: chartType === 'line' ? colors[idx % colors.length] + '33' : colors[idx % colors.length],
                    tension: 0.4,
                    fill: chartType === 'line'
                };
            });
            
            const ctxAnalisa = document.getElementById('chart-analisa').getContext('2d');
            if (charts.analisa) charts.analisa.destroy();
            
            charts.analisa = new Chart(ctxAnalisa, {
                type: chartType,
                data: {
                    labels: monthNames,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        datalabels: {
                            display: showValues,
                            anchor: 'end',
                            align: 'top',
                            font: { weight: 'bold', size: 9 },
                            formatter: function(v) { return v > 0 ? v.toLocaleString('id-ID') : ''; }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toLocaleString('id-ID');
                                }
                            }
                        }
                    },
                    scales: { y: { beginAtZero: true } },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
            
            const thead = document.getElementById('table-analisa-head');
            let theadHTML = '<tr><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase sticky left-0 bg-gray-50">Bulan</th>';
            selectedYears.forEach(function(year) {
                theadHTML += '<th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">' + year + '</th>';
            });
            theadHTML += '</tr>';
            thead.innerHTML = theadHTML;
            
            const tbody = document.getElementById('table-analisa-body');
            tbody.innerHTML = '';
            monthNames.forEach(function(month) {
                let row = '<tr class="hover:bg-gray-50"><td class="px-3 py-2 text-xs text-gray-900 sticky left-0 bg-white">' + month + '</td>';
                selectedYears.forEach(function(year) {
                    const value = yearData[year][month] || 0;
                    row += '<td class="px-3 py-2 text-xs text-gray-900 text-right font-medium">' + value.toLocaleString('id-ID') + '</td>';
                });
                row += '</tr>';
                tbody.innerHTML += row;
            });
            
            const tfoot = document.getElementById('table-analisa-foot');
            let tfootHTML = '<tr class="font-bold"><td class="px-3 py-2 text-xs text-gray-900 sticky left-0 bg-gray-100">TOTAL</td>';
            selectedYears.forEach(function(year) {
                const total = Object.values(yearData[year]).reduce(function(sum, v) { return sum + v; }, 0);
                tfootHTML += '<td class="px-3 py-2 text-xs text-gray-900 text-right">' + total.toLocaleString('id-ID') + '</td>';
            });
            tfootHTML += '</tr>';
            tfoot.innerHTML = tfootHTML;
        }

        function downloadChart(chartId, filename) {
            const canvas = document.getElementById(chartId);
            const url = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = filename + '_' + new Date().getTime() + '.png';
            link.href = url;
            link.click();
        }

        function exportChartPDF(chartId, title) {
            const canvas = document.getElementById(chartId);
            const imgData = canvas.toDataURL('image/png');
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>' + title + '</title><style>body { margin: 0; padding: 20px; font-family: Arial, sans-serif; } h2 { text-align: center; margin-bottom: 20px; } img { display: block; margin: 0 auto; max-width: 100%; } @media print { body { padding: 0; } }</style></head><body><h2>' + title + '</h2><img src="' + imgData + '" /><script>window.onload = function() { window.print(); }<\/script></body></html>');
            printWindow.document.close();
        }

        function exportTableToCSV(type) {
            let csv = [];
            let filename = '';
            
            if (type === 'overview') {
                csv.push(['Kategori', 'Total Kunjungan', 'Persentase']);
                const rows = document.querySelectorAll('#table-overview-body tr');
                rows.forEach(function(row) {
                    const cols = row.querySelectorAll('td');
                    csv.push([cols[0].textContent, cols[1].textContent.replace(/\./g, ''), cols[2].textContent]);
                });
                const total = document.getElementById('total-overview').textContent;
                csv.push(['TOTAL', total.replace(/\./g, ''), '100%']);
                filename = 'rekap_overview.csv';
            } else if (type === 'pelayanan-jenis') {
                csv.push(['Jenis Pelayanan', 'Total Kunjungan', 'Persentase']);
                const rows = document.querySelectorAll('#table-pelayanan-jenis-body tr');
                rows.forEach(function(row) {
                    const cols = row.querySelectorAll('td');
                    csv.push([cols[0].textContent, cols[1].textContent.replace(/\./g, ''), cols[2].textContent]);
                });
                const total = document.getElementById('total-pelayanan-jenis').textContent;
                csv.push(['TOTAL', total.replace(/\./g, ''), '100%']);
                filename = 'pelayanan_per_jenis.csv';
            } else if (type === 'pelayanan-klinik') {
                csv.push(['Klinik', 'Total Kunjungan', 'Persentase']);
                const rows = document.querySelectorAll('#table-pelayanan-klinik-body tr');
                rows.forEach(function(row) {
                    const cols = row.querySelectorAll('td');
                    csv.push([cols[0].textContent, cols[1].textContent.replace(/\./g, ''), cols[2].textContent]);
                });
                const total = document.getElementById('total-pelayanan-klinik').textContent;
                csv.push(['TOTAL', total.replace(/\./g, ''), '100%']);
                filename = 'pelayanan_per_klinik.csv';
            } else if (type === 'status-bayar') {
                csv.push(['Cara Bayar', 'Total Kunjungan', 'Persentase']);
                const rows = document.querySelectorAll('#table-status-bayar-body tr');
                rows.forEach(function(row) {
                    const cols = row.querySelectorAll('td');
                    csv.push([cols[0].textContent, cols[1].textContent.replace(/\./g, ''), cols[2].textContent]);
                });
                const total = document.getElementById('total-status-bayar').textContent;
                csv.push(['TOTAL', total.replace(/\./g, ''), '100%']);
                filename = 'status_cara_bayar.csv';
            } else if (type === 'status-jaminan') {
                csv.push(['Jaminan', 'Total Kunjungan', 'Persentase']);
                const rows = document.querySelectorAll('#table-status-jaminan-body tr');
                rows.forEach(function(row) {
                    const cols = row.querySelectorAll('td');
                    csv.push([cols[0].textContent, cols[1].textContent.replace(/\./g, ''), cols[2].textContent]);
                });
                const total = document.getElementById('total-status-jaminan').textContent;
                csv.push(['TOTAL', total.replace(/\./g, ''), '100%']);
                filename = 'status_jaminan.csv';
            } else if (type === 'analisa') {
                const headers = [];
                document.querySelectorAll('#table-analisa-head th').forEach(function(th) {
                    headers.push(th.textContent);
                });
                csv.push(headers);
                
                const rows = document.querySelectorAll('#table-analisa-body tr');
                rows.forEach(function(row) {
                    const cols = row.querySelectorAll('td');
                    const rowData = [];
                    cols.forEach(function(col) {
                        rowData.push(col.textContent.replace(/\./g, ''));
                    });
                    csv.push(rowData);
                });
                
                const footCols = [];
                document.querySelectorAll('#table-analisa-foot td').forEach(function(td) {
                    footCols.push(td.textContent.replace(/\./g, ''));
                });
                csv.push(footCols);
                
                filename = 'analisa_periode.csv';
            }
            
            const csvContent = csv.map(function(row) { return row.join(','); }).join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        function exportTableToPDF(type) {
            let title = '';
            let tableHTML = '';
            
            if (type === 'overview') {
                title = 'Rekap Data Overview';
                tableHTML = document.getElementById('table-overview-body').parentElement.outerHTML;
            } else if (type === 'pelayanan-jenis') {
                title = 'Rekap Per Jenis Pelayanan';
                tableHTML = document.getElementById('table-pelayanan-jenis-body').parentElement.outerHTML;
            } else if (type === 'pelayanan-klinik') {
                title = 'Rekap Per Klinik';
                tableHTML = document.getElementById('table-pelayanan-klinik-body').parentElement.outerHTML;
            } else if (type === 'status-bayar') {
                title = 'Tabel Status Cara Bayar';
                tableHTML = document.getElementById('table-status-bayar-body').parentElement.outerHTML;
            } else if (type === 'status-jaminan') {
                title = 'Tabel Status Jaminan';
                tableHTML = document.getElementById('table-status-jaminan-body').parentElement.outerHTML;
            } else if (type === 'analisa') {
                title = 'Tabel Analisa Per Bulan';
                tableHTML = '<table border="1" cellpadding="5" cellspacing="0" style="border-collapse:collapse;width:100%;">';
                tableHTML += document.getElementById('table-analisa-head').outerHTML;
                tableHTML += document.getElementById('table-analisa-body').outerHTML;
                tableHTML += document.getElementById('table-analisa-foot').outerHTML;
                tableHTML += '</table>';
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>' + title + '</title><style>body { margin: 0; padding: 20px; font-family: Arial, sans-serif; } h2 { text-align: center; margin-bottom: 20px; } table { width: 100%; border-collapse: collapse; } th, td { border: 1px solid #ddd; padding: 8px; text-align: left; } th { background-color: #f3f4f6; font-weight: bold; } tfoot { background-color: #e5e7eb; font-weight: bold; } @media print { body { padding: 10px; } }</style></head><body><h2>' + title + '</h2>' + tableHTML + '<script>window.onload = function() { window.print(); }<\/script></body></html>');
            printWindow.document.close();
        }

        fetchData();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b93c00cc5db5724',t:'MTc2NzYyNDIzMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
